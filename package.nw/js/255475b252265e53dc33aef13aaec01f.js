'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('request'),{URL:d}=require('url'),e=require('querystring'),f=require('qrcode-terminal'),g=require('./15ba1827c7f6564a45df6bd44da3a977.js'),h=require('./6b0bd6bb0fa981d25d4c0fb4b85edbab.js'),i=require('./78294f0b5b50fc38258d7028553744ef.js'),j=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),k=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),l=require('./f171257bbcaef547a3cf27266ccb0db2.js'),m=require('./9c906d27ca74e18d0deaaa231e71fdfa.js'),n=require('./5bdce4f0657e887a1fda83e134c0b823.js'),o=require('./5719b6ded53098ffd9e848abcac30153.js'),p=require('./da7c31daaf542cf1796023d8e344b98a.js'),q={SUCCESS:405,SCANNED:404,CANCELLED:403,TIMEOUT:402,ERROR:500,KEEP_ALIVE:408},r={REQ_ERR_RETRY_INTERVAL:500,SCANNED_TIMEOUT:500,CANCELLED_TIMEOUT:2e3,KEEP_ALIVE_TIMEOUT:2e3,RELOAD_TO_LONGPOLL_TIMEOUT:100,LONGPOLL_TIMEOUT:6e4},s='darwin'===process.platform?'darwin':'win',t=(b='image',c)=>new Promise(async(d,e)=>{try{let j;if(j=i.checkFormat(b),j.error)return e(j.error);if(j=i.checkQROutput(c),j.error)return e(j.error);const k=await n.getLoginInfo(n.QRCODE_FORMAT.IMAGE),{qrcode:m,longPollURL:p}=k;if(c)try{if('base64'===b)a.writeFileSync(c,h.toBase64(m,'jpeg'),'utf8'),d({longPollURL:p,qrcode:c});else if('image'===b)a.writeFileSync(c,m,null),d({longPollURL:p,qrcode:c});else try{const{body:b}=await g({url:`${l.jsDecodeLoginQRCodeURL}`,method:'post',body:m});if(b.result){const g=decodeURIComponent(b.result);try{f.generate(g,(b)=>{a.writeFileSync(c,b,null),d({longPollURL:p,qrcode:b})})}catch(a){e(o.ERROR.GENERIC_ERROR(a.toString()))}}}catch(a){e(o.ERROR.GENERIC_ERROR(a.toString()))}}catch(a){e(o.ERROR.GENERIC_ERROR(a.toString()))}else try{if('base64'===b){const a=h.toBase64(m,'jpeg');d({longPollURL:p,qrcode:a})}else if('image'===b)d({longPollURL:p,qrcode:m});else try{const{body:a}=await g({url:`${l.jsDecodeLoginQRCodeURL}`,method:'post',body:m});if(a.result){const b=decodeURIComponent(a.result);try{f.generate(b,(a)=>{d({longPollURL:p,qrcode:a})})}catch(a){e(o.ERROR.GENERIC_ERROR(a.toString()))}}}catch(a){e(o.ERROR.GENERIC_ERROR(a.toString()))}}catch(a){e(a)}}catch(a){e(o.ERROR.GENERIC_ERROR(a.toString()))}}),u=(a)=>new Promise((b,c)=>{v(b,c,a)}),v=async(a,b,d,e)=>{c({url:`${d}${e?'&last='+e:''}&_=${+new Date}`,headers:{"Content-Type":'application/javascript'},timeout:r.LONGPOLL_TIMEOUT,resolveWithFullResponse:!0},(c,e,f)=>{if(c)'ECONNRESET'===c.code&&b(o.ERROR.BAD_NETWORK());else{eval(f);const c=window.wx_errcode,e=window.wx_code;switch(c){case q.SUCCESS:{let b=l.LOGIN_REDIRECT_URL;b=b.replace(/&amp;/g,'&'),b+=(-1<b.indexOf('?')?'&':'?')+`code=${e}&state=${s}`,a(b);break}case q.SCANNED:{setTimeout(v.bind(this),r.SCANNED_TIMEOUT,a,b,d,c);break}case q.CANCELLED:{b(o.ERROR.LOGIN_CANCEL());break}case q.TIMEOUT:{b(o.ERROR.QR_OUTDATED());break}case q.ERROR:{b(o.ERROR.LOGIN_RETRY());break}case q.KEEP_ALIVE:setTimeout(v.bind(this),r.KEEP_ALIVE_TIMEOUT,a,b,d);default:}}})},w=(b)=>{let c,d='';b.get('/login',async(b,e)=>{function f(b,c,d){if(b)if(c)try{a.writeFileSync(b,JSON.stringify(_extends({},JSON.parse(c),d)),'utf8')}catch(f){a.writeFileSync(b,JSON.stringify(_extends({},d,{error:c.toString()})),'utf8')}else a.writeFileSync(b,JSON.stringify(d),'utf8')}try{global.CLI.pendingLogin=!0,j.dispatch(m.loginExpired());const a=decodeURIComponent(b.mQuery.format||'')||'image',g=decodeURIComponent(b.mQuery.qroutput||''),h=decodeURIComponent(b.mQuery.resultoutput||''),l=decodeURIComponent(b.mQuery.cli||''),n=decodeURIComponent(b.mQuery.from||'');l?p('cli_login',null,null,n?{engine_from:n}:null):p('http_login',null,null,n?{engine_from:n}:null);let o;if(o=i.checkFormat(a),o.error)return e.statusCode=400,void e.end(o.error);if(o=i.checkQROutput(g),o.error)return e.statusCode=400,void e.end(o.error);const{qrcode:q,longPollURL:r}=await t(a,g);e.statusCode=200,e.end(q,'image'===a?null:'utf8'),c=k.LOGIN_STATUS.PENDING,u(r).then(async(a)=>{try{await j.dispatch(m.login(a));c=k.LOGIN_STATUS.SUCCESS,f(h,null,{status:k.LOGIN_STATUS.SUCCESS})}catch(a){c=k.LOGIN_STATUS.FAIL,d=a.toString(),f(h,a,{status:k.LOGIN_STATUS.FAIL})}global.CLI.pendingLogin=!1}).catch((a)=>{c=k.LOGIN_QR_STATUS.FAIL,d=a.toString(),global.CLI.pendingLogin=!1;try{f(h,a,{status:k.LOGIN_STATUS.FAIL})}catch(a){d=`write login result to output path failed: ${a.toString()}`}})}catch(a){global.CLI.pendingLogin=!1,e.statusCode=400;try{JSON.parse(a)&&e.writeHead(400,{"Content-Type":'application/json;  charset=utf-8'})}catch(a){}e.end(a.toString(),'utf8')}}),b.get('/loginresult',async(a,b)=>{b.statusCode=200,b.end(JSON.stringify({loginStatus:c,loginStatusMsg:d}))})};module.exports={registerHandlers:w}}(require('lazyload'),require);