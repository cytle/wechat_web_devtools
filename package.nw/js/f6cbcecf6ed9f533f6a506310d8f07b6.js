'use strict';!function(require,directRequire){function a(a){return a.replace(C,'').replace(D,'').replace(E,'')}function b(){let a=r.getUserInfo(),b=a?a.openid:'unknow';return b||''}function c(a,c){let d=a.appid,e=b();if(c||!F[`${d}_${e}`]){let a=k.join(B,e,d);(c||!l.existsSync(a))&&(n.sync(k.join(a,x)),n.sync(k.join(a,y)),n.sync(k.join(a,z))),F[`${d}_${e}`]=!0}}function d(a){return C.test(a)?x:D.test(a)?y:E.test(a)?z:A}function e(a,c,d){let e=a.appid,f=b(),g=m.createHash('md5');return c=c||`${Date.now()}`,g.update(c),`${e}.${f}.${g.digest('hex')}${d}`}function f(a){let c=a.appid,d=b();return k.join(B,d,c)}function g(c,e){/^http:\/\/usr\/?$/i.test(c)?c='http://usr/./':/^http:\/\/tmp\/?$/i.test(c)?c='http://tmp/./':/^http:\/\/store\/?$/i.test(c)&&(c='http://store/./');let f=d(c);e=e||s.getCurrent();let g;if(f!==A){c=a(c);let d,h;d=e.appid||'',h=b();let i=k.join(B,h,d,f);if(i=/(\/|\\)$/.test(i)?i:i+'/',i=k.normalize(i),g=k.join(B,h,d,f,c),!g.startsWith(i))return{error:!0}}else{let a=e.miniprogramRoot,b=k.extname(c),d={".wxml":!0,".js":!0,".wxss":!0};if('mingganci'!==s.getCurrent().compileType&&'game'!==s.getCurrent().compileType&&(d['.json']=!0),!d[b]){let b;if(a?(b=k.join(e.projectpath,a),b=/(\/|\\)$/.test(b)?b:b+'/',b=k.normalize(b),g=k.join(e.projectpath,a,c)):(b=k.join(e.projectpath),b=/(\/|\\)$/.test(b)?b:b+'/',b=k.normalize(b),g=k.join(e.projectpath,c)),!g.startsWith(b))return{error:!0}}}return{error:!1,fileRealPath:g,type:f}}function h(a,c,d){let f=e(a,c,d),g=b(),h=k.join(B,g,a.appid,y,f);return l.writeFileSync(h,c),`${v}${f}`}function i(a,b,c){const d=1,e=65536;(function(a,b,c){if('string'!=typeof b)throw new Error('_dest must be a string');if('string'!=typeof a)throw new Error('_src must be a string');if('number'==typeof c&&c&&c!==d)throw Error(`EINVAL: invalid argument, copyfile -> '${b}'`)})(a,b,c);const f=c===d?'wx':'w',{size:g,mode:h}=l.statSync(a),j=l.openSync(a,'r'),k=l.openSync(b,f,h),m=g<e?g:e;let n=0;const o=g<e?0:g%e,p=0;let q=Buffer.allocUnsafe(m);for(let d=0;m+n+o<=g;d++,n=m*d)l.readSync(j,q,p,m,n),l.writeSync(k,q,p,m,n);if(o){const a=o;q=Buffer.allocUnsafe(a),l.readSync(j,q,p,a,n),l.writeSync(k,q,p,a,n)}l.closeSync(j),l.closeSync(k)}function j(a,b){let c=g(b);if(c.type!==x)return{error:!0,reason:`permission denied, open ${b}`};let d=c.fileRealPath,e=k.dirname(d),f=!1;try{let a=l.lstatSync(e);f=a.isDirectory()}catch(a){}return f?{error:!1,realDirPath:e,fileRealPath:d}:{error:!0,reason:`no such file or directory ${b}`}}const k=require('path'),l=require('fs'),m=require('crypto'),n=require('mkdir-p'),o=require('glob'),p=require('rmdir'),q=require('adm-zip'),r=require('./89ba85d67a88f7636d657c22b5d3e038.js'),s=require('./3bfffbe88b3d923921f851c0697974fe.js'),{DATA_PATH:t,USER_DATA_PATH:u,TMP_DATA_PATH:v,STORE_DATA_PATH:w}=require('./37be435102276ea9cf47609ff6535cd4.js'),x='usr',y='tmp',z='store',A='package',{WeappFileSystem:B}=require('./92320c1386e6db6a6f2556736a9bc280.js'),C=new RegExp(`^${u+'/'}`),D=new RegExp(`^${v}`),E=new RegExp(`^${w}`);var F={};const G=(a,b=!1)=>{let c;switch(a){case x:{c=g('http://usr/./').fileRealPath;break}case y:{c=g('http://tmp/./').fileRealPath;break}case z:{c=g('http://store/./').fileRealPath;break}case A:{c=g('./').fileRealPath;break}default:return null;}return c=b&&c?/(\/|\\)$/.test(c)?c:c+'/':/(\/|\\)$/.test(c)?c.slice(0,-1):c,k.normalize(c)};var H={saveStoreFile:function(a,b){let c=a.appid,d=g(b);if(d.type===y){let a=d.fileRealPath;if(l.existsSync(a)){const b=l.lstatSync(a);if(b.isSymbolicLink())return{error:!0,reason:'tempFilePath is not a regular file'};let c=k.basename(a),d=l.readFileSync(a),e=k.join(a,'..','..',z,c);return l.writeFileSync(e,d),l.unlink(a,()=>{}),{error:!1,savedFilePath:`${w}${c}`}}}return{error:!0,reason:'tempFilePath file not exist'}},saveUsrFile:function(a,c,d){let e=a.appid,f=b(),h=g(d,a);if(h.type!==x)return{error:!0,reason:`permission denied, open "${d}"`};let i=h.fileRealPath,j=k.dirname(i),m=!1;try{let a=l.lstatSync(j);m=a.isDirectory()}catch(a){}if(!m)return{error:!0,reason:`no such file or directory "${k.dirname(d)}"`};let n=g(c);if(!l.existsSync(n.fileRealPath))return{error:!0,reason:`no such file or directory "${c}"`};const o=l.lstatSync(n.fileRealPath);if(o.isSymbolicLink())return{error:!0,reason:'tempFilePath is not a regular file'};let p=l.readFileSync(n.fileRealPath);return l.writeFileSync(i,p),{error:!1,savedFilePath:d}},copyFileToTemp:function(a,b,c){let d=l.readFileSync(b);return h(a,d,c)},copyFileDataToTemp:h,getUsrFileList:function(a){let c=b(),d=a.appid,e=k.join(B,c,d,z),f={},g=o.sync('**/**',{statCache:f,nodir:!0,stat:!0,cwd:e}),h=0;for(let b in f)h+=f[b].size;return{error:!1,fileList:g,totalSize:h}},getSavedFileList:function(a){let c=b(),d=a.appid,e=k.join(B,c,d,z),f=0,g={},h=o.sync('**/**',{statCache:g,nodir:!0,stat:!0,cwd:e}),i=h.map((a)=>{let b=g[k.join(e,a).replace(/\\/g,'/')];return f+=b.size,{filePath:`${w}${a}`,size:b.size,createTime:parseInt(b.ctime.getTime()/1e3)}});return{error:!1,fileList:i,totalSize:f}},readFile:function(a,b,c){let d=g(b),e=d.fileRealPath;if(!l.existsSync(e))return{error:!0,reason:`${b} not found`};const f=l.lstatSync(e);if(f.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};let h=l.readFileSync(e,c);return{error:!1,fileData:h}},writeFile:function(a,b,c,d='utf8'){let e=j(a,b);if(e.error)return e;let f=e.fileRealPath;if(l.existsSync(f)){const a=l.lstatSync(f);if(a.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};if(a.isDirectory())return{error:!0,reason:`illegal operation on a directory, open ${b}`}}return l.writeFileSync(f,c,d),{error:!1}},mkdir:function(a,b){let c=j(a,b);if(c.error)return c;let d=c.fileRealPath;return l.existsSync(d)?{error:!0,reason:`file already exists ${b}`}:(n.sync(d),{error:!1})},rmdir:function(a,c){let d=j(a,c);if(d.error)return d;let e=d.fileRealPath,f=d.realDirPath,g=b();if(f===k.join(B,g,a.appid))return{error:!0,reason:`permission denied, open ${c}`};if(!l.existsSync(e)||!l.lstatSync(e).isDirectory())return{error:!0,reason:`no such file or directory  ${c}`};let h=l.readdirSync(e).filter((a)=>{return 0!==a.indexOf('.')});return 0===h.length?(l.rmdirSync(e),{error:!1}):{error:!0,reason:`directory not empty`}},readdir:function(a,b){let c=j(a,b+'/');if(c.error)return c;let d=c.fileRealPath;if(!l.existsSync(d))return{error:!0,reason:`no such file or directory  ${b}`};if(!l.lstatSync(d).isDirectory())return{error:!0,reason:`not a directory  ${b}`};let e=l.readdirSync(d).filter((a)=>{return 0!==a.indexOf('.')});return{error:!1,files:e}},createTmpfileName:function(a,b){return`${v}${e(a,'',b)}`},initTmpfileName:function(a,b,c){return`${v}${e(a,b,c)}`},getFileSystemDir:f,unlink:function(a,b){let c=g(b,a);if(c.type===A)return{error:!0,reason:`fail permission denied, open "${b}"`};let d=c.fileRealPath;if(!l.existsSync(d))return{error:!0,reason:`fail no such file or directory "${b}"`};let e=l.lstatSync(d);if(e.isDirectory())return{error:!0,reason:`fail operation not permitted, unlink "${b}"`};try{l.unlinkSync(d)}catch(a){return{error:!0,reason:a.toString()}}return{error:!1}},stat:function(a,b){let c=g(b,a);if(c.type===A&&0===b.indexOf(t))return{error:!0,reason:`fail permission denied, open "${b}"`};let d=c.fileRealPath;if(!l.existsSync(d))return{error:!0,reason:`fail no such file or directory "${b}"`};let e=l.lstatSync(d);return{error:!1,mode:e.mode,size:e.size,lastAccessedTime:parseInt(e.atimeMs/1e3),lastModifiedTime:parseInt(e.mtimeMs/1e3)}},saveBase64DataToFile:function(a,c,d){let f=a.appid,g=b(),h=e(a,c,d);return l.writeFileSync(k.join(B,g,f,y,h),c,{encoding:'base64'}),{error:!1,tempFilePath:`${v}${h}`}},clearFileSystem:function(a){let b=f(a);p(b,()=>{c(a,!0)})},unzip:function(a,b,c){const d=g(b),e=d.fileRealPath;if(!e||!l.existsSync(e))return{error:!0,reason:`no such file or directory, unzip "${b}"`};const f=c,h=g(c),i=h.fileRealPath;if(!i||h.type!==x)return{error:!0,reason:`permission denied, unzip "${f}"`};const j=k.dirname(i);if(!l.existsSync(j)||l.lstatSync(j).isSymbolicLink())return{error:!0,reason:`no such file or directory, unzip "${f}"`};const m=l.lstatSync(e);if(m.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};try{const a=new q(e),b=a.getEntries();for(const a of b){const b=a.entryName;if(/^\.\.(\\|\/)+/.test(b))throw new Error('illegal access');if(/(\\|\/)+\.\.(\\|\/)+/.test(b))throw new Error('illegal access');if(/(\\|\/)+\.\.$/.test(b))throw new Error('illegal access')}a.extractAllTo(i,!0)}catch(a){return{error:!0,reason:'unzip failed'}}return{error:!1}},rename:function(a,b,c){const d=g(b),e=d.fileRealPath;if(!e||!l.existsSync(e))return{error:!0,reason:`no such file or directory, rename "${b}"`};if(d.type===A)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};const f=g(c),h=f.fileRealPath;if(!h||f.type!==x)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};const i=G(x,!0),j=G(y,!0),m=G(z,!0),n=G(A,!0);if(!e.startsWith(i)&&!e.startsWith(j)&&!e.startsWith(m)&&!e.startsWith(n))return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(e===i||e===j||e===m||e===n)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(!h.startsWith(i)||i===h)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(l.lstatSync(e).isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};if(l.existsSync(h)&&l.lstatSync(h).isSymbolicLink())return{error:!0,reason:`${c} is not a regular file`};const o=k.dirname(h);if(!l.existsSync(o)||l.lstatSync(o).isSymbolicLink())return{error:!0,reason:`no such file or directory, rename "${c}"`};try{l.renameSync(e,h)}catch(a){return{error:!0,reason:'rename failed'}}return{error:!1}},copyFile:function(a,b,c){const d=g(b),e=d.fileRealPath;if(!e||!l.existsSync(e))return{error:!0,reason:`no such file or directory, copyFile "${b}"`};const f=g(c),h=f.fileRealPath;if(!h||f.type!==x)return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};const j=l.lstatSync(e);if(!j.isFile())return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(j.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};const m=G(x,!0);if(!h.startsWith(m)||m===h)return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(l.existsSync(h)&&l.lstatSync(h).isSymbolicLink())return{error:!0,reason:`${c} is not a regular file`};if(h===e)return{error:!1};if(l.existsSync(h)){try{l.unlinkSync(h)}catch(a){}try{l.rmdirSync(h)}catch(a){}}const n=k.dirname(h);if(!l.existsSync(n)||l.lstatSync(n).isSymbolicLink())return{error:!0,reason:`no such file or directory, copyFile "${c}"`};try{i(e,h)}catch(a){return{error:!0,reason:'copyFile failed'}}return{error:!1}}};Object.getOwnPropertyNames(H).forEach(function(a){const b=H[a];H[a]=function(){return c(arguments[0]),b.apply(H,arguments)}}),H.getFileRealPath=g,H.removeSavedFile=function(a){let b=g(a),c=b.fileRealPath;if(b.type===z&&l.existsSync(c)){try{l.unlinkSync(c)}catch(a){}return{error:!1}}return{error:!0,reason:'file not exist'}},H.getFileStat=function(a){let b=g(a),c=b.fileRealPath;try{let a=l.statSync(c);return{error:!1,size:a.size,createTime:parseInt(a.ctime.getTime()/1e3)}}catch(a){return{error:!0,reason:'file not found'}}},H.getFileInfo=function(a,b,c){let d=g(a);if(c&&d.type!==c)return{error:!0,reason:'file not find'};let e=d.fileRealPath;if(l.existsSync(e)){let c=l.lstatSync(e);if(c.isDirectory())return{error:!0,reason:`${a} is directory`};if(c.isSymbolicLink())return{error:!0,reason:`${a} is not a regular file`};let d=l.readFileSync(e),f='';if('md5'===b){let a=m.createHash('md5');a.update(d),f=a.digest('hex')}else if('sha1'===b){let a=m.createHash('sha1');a.update(d),f=a.digest('hex')}return{error:!1,size:c.size,digest:f}}return{error:!0,reason:'file not exist'}},H.isLocalId=function(a){return 0===a.indexOf(u+'/')||0===a.indexOf(v)||0===a.indexOf(w)},H.USR='usr',H.TMP='tmp',H.STORE='store',H.PACKAGE='package',module.exports=H}(require('lazyload'),require);