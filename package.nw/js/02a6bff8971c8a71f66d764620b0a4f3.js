'use strict';!function(require,directRequire){function a(){const a=g.getCurrent(),b=a.appid===k.TOURIST_APPID,c=a.setting.urlCheck;let d=!0;return b?d=!1:!c&&(d=!1),d}const b=require('fs'),c=require('path'),d=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),e=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),f=require('./233d77ecf0781f44985f684f70e316d0.js'),g=require('./3bfffbe88b3d923921f851c0697974fe.js'),h=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),i=require('./a1dd553cc059d528bb0ef56afed53968.js'),j=require('./common/locales/index.js'),k=require('./56c390e04c10e91a4aa2a2c19d9a885d.js');module.exports={downloadImage:async function(e,i){const k=i.args,l=d.getState(),m=g.getCurrentConfig(),n=1024*(1024*m.setting.DownloadFileSizeLimit);return new Promise((d)=>{let e=!1;const l=(a)=>{e||(d(a),e=!0)};try{let d=0,e=200,o=c.extname(k.url.split('?')[0]);const m=g.getCurrent(),p=h.createTmpfileName(m,o),q=h.getFileRealPath(p),r=q.fileRealPath,s=[],t=k.header||{};t.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;const u={method:'get',url:k.url,encoding:null,headers:t,followRedirect(a){let b=!1;(m.urlCheck||m.isTourist)&&(b=!0);const c=a.statusCode;if(300<=c&&400>c&&(302==c||301==c)){const c=a.caseless.get('location'),d=g.getCurrentRuntimeDomains().download;for(let a=0;a<d.length;a++)if(c&&0===c.indexOf(d[a])){b=!0;break}}return b}};a()?u.agentOptions={secureProtocol:'TLSv1_2_method'}:u.tunnel=!1;const v=f(u);v.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)l({errMsg:`${i.api}:ok`,statusCode:e});else{const b=parseInt(a.headers['content-length']);if(b>n&&(v.abort(),l({errMsg:`${i.api}:fail exceed max file size`})),a.headers['content-type']){const b=a.headers['content-type'].split('/');b&&b[1]&&(o=`.${b[1]}`)}}}).on('error',function(a){a&&'EPROTO'===a.code?l({errMsg:`${i.api}:fail ${j.config.TLS_VERSION_REQUIRED}`}):a&&'ETIMEDOUT'===a.code?l({errMsg:`${i.api}:fail timeout`}):l({errMsg:`${i.api}:fail ${a}`})}).on('data',(a)=>{d+=a.length,s.push(i),d>n&&(v.abort(),l({errMsg:`${i.api}:fail exceed max file size`}))}).on('end',()=>{const a=Buffer.concat(s),c=h.initTmpfileName(m,a,o),d=h.getFileRealPath(c),f=d.fileRealPath;b.writeFileSync(f,a),b.unlink(r,()=>{}),l({errMsg:`${i.api}:ok`,tempFilePath:c,statusCode:e})}).pipe(b.createWriteStream(r))}catch(a){l({errMsg:`${i.api}:fail ${a}`})}})}}}(require('lazyload'),require);