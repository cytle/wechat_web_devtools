'use strict';!function(require,directRequire){const a=require('path'),b=require('react'),c=require('classnames'),d=require('./08daeb1466202b05ac4b7f58871f83db.js'),e=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),f=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),g=require('./ea653f45dc25181ca4f1b108175009b7.js'),h=require('./a8c87029da0fa06e986298d447ab0fe2.js'),i=require('./290634b065605c4034bdb091d12bb500.js'),j=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),k='about:blank',l=require('./72653d4b93cdd7443296229431a7aa9a.js'),m=require('./84705760a8692a44a583377e7f3f3b00.js'),n=require('./3bfffbe88b3d923921f851c0697974fe.js'),o=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),p=require('./common/locales/index.js'),q=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),r=require('./ff946754202ecf377034d29daac7c8d9.js'),{validType:s,tokenManager:t}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),{connect:u}=require('react-redux');class v extends b.Component{constructor(a){super(a),this.syncDialogMap={},this.restartTimer=null,this.storagePannelShow=!1,this.state={heigth:a.heigth},this._onMessage=this.onMessage.bind(this)}componentDidMount(){o.initHelper({setDebuggerWindow:this.props.setDebuggerWindow.bind(this)}),d.register(this._onMessage),this.initWebview()}componentWillUnmount(){this.devtoolsview&&this.devtoolsview.remove(),this.webview&&this.webview.remove(),this.getWidgetDataTimer&&clearTimeout(this.getWidgetDataTimer),d.unRegister(this._onMessage)}componentWillReceiveProps(a){if(a.assdkCallbackInfo!=this.props.assdkCallbackInfo){const{callbackID:b,res:c}=a.assdkCallbackInfo;this.syncDialogMap[b]?(this.syncDialogMap[b].ok(JSON.stringify(c)),delete this.syncDialogMap[b]):d.invokeCallback(b,c)}if(a.jssdkCallbackInfo!=this.props.jssdkCallbackInfo){const{callbackID:b,res:c}=a.jssdkCallbackInfo;this.syncDialogMap[b]?(this.syncDialogMap[b].ok(JSON.stringify(c)),delete this.syncDialogMap[b]):d.invokeCallback(b,c)}(a.compileCommand!=this.props.compileCommand||a.device!=this.props.device)&&(clearTimeout(this.restartTimer),this.restartTimer=setTimeout(()=>{this.restart()})),a.errmsg!=this.props.errmsg&&a.errmsg&&this.showConsole(a.errmsg),a.ready!=this.props.ready&&a.ready&&setTimeout(()=>{this.getWidgetData()})}showConsole(a){if(/\?load$/.test(this.webview.src))return void this.showConsole(a);let b=0;const c=setInterval(()=>{const d=this.dpsWebview.src||'';/\?load$/.test(d)?(this.showConsole(a),clearInterval(c)):(b++,20==b&&clearInterval(c))},500)}showConsole(a){if(this.webview)if(/\?load$/.test(this.webview.src))'string'==typeof a?this.webview.executeScript({code:`console.error(\`${a}\`)`}):this.webview.executeScript({code:`console.group(\`${a.group}\`)
              console.${a.type}(${'string'==typeof a.msg?`\`${a.msg}\``:JSON.stringify(a.msg)})
            console.groupEnd()
            `});else{let b=0;const c=setInterval(()=>{const d=this.webview.src||'';/\?load$/.test(d)?(this.showConsole(a),clearInterval(c)):(b++,10==b&&clearInterval(c))},500)}}onMessage(a){const{command:b,data:c}=a;'APPSERVICE_INVOKE'==b&&this.props.wssdkActions.exec(c)}initWebviewEvent(a){a.addEventListener('dialog',(a)=>{const b=a.messageType||'',c=a.messageText;if('prompt'===b)if(a.preventDefault(),/^____sdk____/.test(c)){const b=JSON.parse(c.replace(/^____sdk____/,'')),d=b.command;'APPSERVICE_INVOKE'===d&&(this.syncDialogMap[b.data.callbackID]=a.dialog,this.props.wssdkActions.exec(b.data))}else c===q.GET_MESSAGE_TOKEN&&a.dialog.ok(r.getToken())})}initWebview(){this.devtoolsview&&this.devtoolsview.remove(),this.webview&&this.webview.remove();const a=this.devtoolsview=document.createElement('webview'),b=this.webview=document.createElement('webview'),c=t.getSessionToken(s.UA_TOKEN);b.setUserAgentOverride(`wechatdevtools widgetservice port/${global.messageCenterPort} token/${c}`),b.setAttribute('partition','persist:appservice'),b.setAttribute('tabIndex','-1'),this.initWebviewEvent(b);const d=`${a.getUserAgent()} widgetservicedevtools port/${global.messageCenterPort}`;a.setUserAgentOverride(d),a.setAttribute('partition','persist:devtools'),a.setAttribute('style','height:100%;width:100%;position:relative;'),a.addEventListener('dialog',function(a){const b=a.messageType||'',c=a.messageText;'prompt'===b&&c===q.GET_MESSAGE_TOKEN&&a.dialog.ok(r.getToken())}),this.serviceContainer.appendChild(b),this.showDevTools()}showDevTools(){const a=this.devtoolsview,b=this.webview;this.container.appendChild(a),this.hackNewWindow(a);const c=()=>{a.removeEventListener('loadcommit',c);const d=()=>{b.removeEventListener('loadcommit',d),b.showDevTools(!0,a),o.initWebview(b),this.loaded=!0,this.props.simulatorActions.setAppLaunched(!0)};b.addEventListener('loadcommit',d),this.resetStatus(),b.src=k};a.addEventListener('loadcommit',c),a.src=k}resetStatus(){this.loaded=!1,this.couldGetData=!1}hackNewWindow(a){a.addEventListener('newwindow',function(a){a.preventDefault();let b=a.targetUrl;b&&('https://developers.google.com/web/tools/chrome-devtools/'===b?b='https://developers.weixin.qq.com/miniprogram/dev/index.html':'https://developers.google.com/web/updates/2017/05/devtools-release-notes'===b&&(b='https://developers.weixin.qq.com/miniprogram/dev/devtools/uplog.html'),nw.Shell.openExternal(b))})}restart(){if(!this.loaded||!this.webview)return;const a=()=>{this.webview.removeEventListener('loadcommit',a),this.loaded=!0,this.couldGetData=!0,this.props.simulatorActions.setAppLaunched(!0)};this.resetStatus(),this.webview.addEventListener('loadcommit',a);const b=this.props.project,c=`http://127.0.0.1:${global.proxyPort}/widgetservice/${b.compileType}`;this.webview.src=c,this.props.simulatorActions.setWidget({ready:!1})}onResizeStop(a,b,c){this.props.windowActions.setDebuggerWindow({height:c})}getWidgetData(){const a=this.props;if((a.compileType==f.conversation||a.compileType==f.search)&&this.props.ready&&this.couldGetData){this.getWidgetDataTimer&&(clearTimeout(this.getWidgetDataTimer),this.getWidgetDataTimer=null);const b={appid:n.getProjectAppID()};a.compileType==f.conversation?b.cachekey=a.condiction.cachekey:a.compileType==f.search&&(b.scene=1,b.query=a.wxaData,b.cachekey='',b.url=a.condiction.debugUrl,!b.query&&this.showConsole({group:p.config.WIDGET_NETWORK_ERROR,type:'error',msg:p.config.SEARCH_DATA_EMPTY})),m.getWidgetData(b).then((a)=>{const b=1e3*a.interval||5e3;d.send({command:'APPSERVICE_ON_EVENT',data:{eventName:'onDataPush',data:{data:a}}}),this.getWidgetDataTimer=setTimeout(()=>{this.getWidgetData()},b)}).catch((a)=>{this.showConsole({group:p.config.WIDGET_NETWORK_ERROR,type:'error',msg:p.config.FAIL_DYNAMIC_PAGE_DATA+a})})}}render(){const a=this.props,d={height:a.height};return a.show&&!a.editorShow&&(d.flex='1'),b.createElement(g,{innerRef:(a)=>this.container=a,width:'100%',height:a.height,className:c('devtools',{"ui-invisible":!a.show}),style:d,topResizable:!0,onResizeStop:this.onResizeStop.bind(this)},b.createElement('div',{className:'ui-divider ui-divider-horizontal',style:{pointerEvents:'none'}}),b.createElement('div',{ref:(a)=>{this.serviceContainer=a},style:{width:0,height:0}}))}}module.exports=u((a)=>{const b=a.toolbar.deviceInfo,c=a.project.current,d=c.compileType,e=c.condiction[d]||{},f=e.list[e.current]||{},g=a.simulator.widget||{};return{project:c,compileType:d,libVersion:c.libVersion,assdkCallbackInfo:a.simulator.assdkCallbackInfo,jssdkCallbackInfo:a.simulator.jssdkCallbackInfo,editorShow:a.window.editor&&a.window.editor.show,show:a.window.debug.show,compileCommand:a.simulator.compileCommand,wxaData:g.wxaData||'',errmsg:g.errmsg||'',ready:g.ready,condiction:f,device:b}},(a)=>({simulatorActions:e.bindActionCreators(j,a),windowActions:e.bindActionCreators(h,a),wssdkActions:e.bindActionCreators(i,a),setDebuggerWindow:e.bindActionCreators(h.setDebuggerWindow,a)}))(v)}(require('lazyload'),require);