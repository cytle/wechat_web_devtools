'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('mkdir-p'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./common/locales/index.js'),f=require('./5321b622f9bab971490e99e09b2389a9.js'),g=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),h=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),j=require('./3e74bc0c6a5fa450386148788cc0cf44.js'),i=require('./db2217eb4cff896bdcbc50abe005058f.js'),k=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),l=require('./874074ba4ecebc4e49310ccc42243ff5.js'),m=require('./19404cae4023ed740f4fe4bce92ebf66.js'),n=require('./3bfffbe88b3d923921f851c0697974fe.js'),o=require('./3892cb9d0783075a973c350c41401370.js'),p=require('./da7c31daaf542cf1796023d8e344b98a.js'),q=require('./664c85134de31b9a04ff1f03a1492daf.js'),r=q.get(),s=()=>{},{TCB_STAGE_PREPARE:t,TCB_STAGE_GET_FUNCTION_INFO:u,TCB_STAGE_CHECK_TRIGGERS:v,TCB_STAGE_UPDATE_FUNCTION_CONFIG:w,TCB_STAGE_COMPRESS_FUNCTION_CODE:x,TCB_STAGE_WILL_UPLOAD_FUNCTION:y,TCB_STAGE_UPLOAD_FUNCTION:z,TCB_STAGE_UPLOAD_FUNCTION_TRIGGERS:A,TCB_STAGE_WAIT_FUNCTION_UPDATE:B,TCB_STAGE_WAIT_FUNCTION_UPDATE_AND_NPM:C,TCB_STAGE_UPLOAD_DONE:D}=e.config,E=(d,e)=>{for(let f,g=0,h=e.length;g<h;g++)f=b.join(d,e[g].FunctionName),a.existsSync(f)||c.sync(f)},F=async(a)=>{const b=n.getCurrentTcbInfo();let c=b.currentEnv&&b.currentEnv.namespace;if(c)return c;let d,e=(await G()(a))||[];if(0>=e.length)d=i.get(k.WINDOW_REGISTRY.CLOUD_CONSOLE),d?d.focus():a({type:g.WINDOW_SET_CLOUD,data:{console:{show:!0}}});else{if(1==e.length)return a(H(0)),c=e[0].namespace,c;d=i.get(k.WINDOW_REGISTRY.CLOUD_SCF_ACTION),d?d.focus():a({type:g.WINDOW_SET_CLOUD,data:{fnaction:{show:!0},cloudfunctionRoot:{show:!0}}})}},G=(a)=>{return async(b)=>{try{let c=await j.getEnvList(a);return b({type:g.TCB_SET_ENV_LIST,data:c.env_list}),c.env_list}catch(c){(!a.hasOwnProperty('showTips')||a.showTips)&&b({type:g.INFO_SHOW_ERROR,data:{message:c.toString()}})}}},H=(a)=>{return{type:g.TCB_SELECT_ENV,data:a}},I=(a)=>{return async(c,d)=>{const h=`getTcbFuncList-${+new Date}`;try{a.showTips&&r.add({id:h,name:e.config.TCB_GET_FUNC_LIST,type:'getTcbFuncList',progressIndeterminate:!0,status:'pending'});let k=await F(c,d);if(!k)return;const i=d(),l=i.project.current||{},m=b.join(l.projectpath,l.cloudfunctionRoot);let n=`${Date.now()}${Math.random()}`,o=await j.getTcbFuncList({namespace:k,pageIndex:0,pageSize:f.FUNC_LIST_PAGE_SIZE}),p=[].concat(o.Functions);if(a.writeFile&&E(m,o.Functions),c({type:g.TCB_SET_SCF_LIST,data:{list:o.Functions,pageIndex:0,total:o.total,namespace:k,updateKey:n}}),o.total>f.FUNC_LIST_PAGE_SIZE){let b=parseInt((o.total-1)/f.FUNC_LIST_PAGE_SIZE);for(let d,e=1;e<b;e++)d=await j.getTcbFuncList({namespace:k,pageIndex:e,pageSize:f.FUNC_LIST_PAGE_SIZE}),p=p.concat(d.Functions),a.writeFile&&E(m,d.Functions),c({type:g.TCB_SET_SCF_LIST,data:{list:d.Functions,pageIndex:e,total:o.total,namespace:k,updateKey:n}})}return c({type:g.TCB_CLEAN_SCF_LIST,data:{namespace:k,updateKey:n}}),a.showTips&&r.markSuccess(h),p}catch(b){a.showTips&&(r.updateDetails(h,b.toString()),r.markFail(h,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG}))}}},J=(a)=>{return{type:g.TCB_CONSOLE_COMMAND,data:a}},K=(a)=>{return 1024>a?`${a} B`:1048576>a?`${(a/1024).toFixed(1)} KB`:`${(a/1024/1024).toFixed(1)} MB`},L=(a)=>{let b=[];return a.hasOwnProperty('packSize')&&b.push(`上传包大小：${K(a.packSize)}`),a.hasOwnProperty('filesCount')&&b.push(`文件数量：${a.filesCount}`),b.join('\uFF0C')},M=(c)=>{const d=(c,e)=>{if(!a.existsSync(c))return e;const f=new Set,g=new Set;for(const a of e)a.includes('/')?g.add(a):f.add(a);if(f.size){const b=new Set(a.readdirSync(c)),d=new Set([...f].filter((a)=>!b.has(a)));if(d.size)return d}if(g.size){const a={};for(const b of g){const[c,...d]=b.split('/');a[c]||(a[c]=new Set),a[c].add(d.join('/'))}for(const e in a){const f=d(b.join(c,e),a[e]);if(f.size)return f}}return new Set};if(a.existsSync(c)){const e=JSON.parse(a.readFileSync(c,'utf8'));if(e.dependencies){const a=new Set(Object.keys(e.dependencies)),f=b.join(b.dirname(c),'node_modules');return d(f,a)}}},N=async(a)=>{return new Promise(async(b,c)=>{let e=!1;const{namespace:f,functionName:g,onStatusUpdate:h=s,maxWaitTimeout:i=900000}=a,k=setTimeout(()=>{e||(e=!0,c(new Error('timeout waiting for function to deploy')))},i);try{let a='';for(const c=+new Date;!e&&+new Date-c<i;){const c=await j.getTcbFuncInfo({namespace:f,functionName:g});switch(global.appConfig.isDev&&console.warn('info for func',g,c),c.Status){case m.FUNCTION_STATUS.Creating:{a!==c.Status&&h(c.Status);break}case m.FUNCTION_STATUS.Updating:{a!==c.Status&&h(c.Status);break}case m.FUNCTION_STATUS.CreateFailed:throw new Error(`创建云函数失败：${c.StatusDesc}`);case m.FUNCTION_STATUS.UpdateFailed:throw new Error(`更新云函数失败：${c.StatusDesc}`);case m.FUNCTION_STATUS.Active:{e=!0,b();break}}}}catch(a){global.appConfig.isDev&&(console.trace(),console.error(a));try{d.error(`upload ${f} ${g} failed: `,'string'==typeof a?a:JSON.stringify(a))}catch(a){d.error(`upload ${f} ${g} failed: `,a.toString())}clearTimeout(k),c(a)}})},O=(a)=>{return async(c,f)=>{async function g(){const e=+new Date,g=await F(c,f);if(!g)return!1;const{dirPath:l,showTips:n,runtime:o,syncFunctions:q,createFunction:s,installDependency:v}=a;if(!v)try{const a=b.join(l,'package.json'),d=M(a);if(d.size){const a=await((a)=>new Promise((b)=>{c(h.setConfirmInfo({show:!0,content:`云函数中有以下未安装的依赖，如果未安装即全量上传，有可能云函数无法使用，是否确认上传？\n${[...a].join(', ')}`,callback:(a)=>{b(a)}}))}))(d);if(!a)return!1}}catch(a){d.error(`uploadTcbFunc check npm failed with error: ${a.toString()}}`)}let A=t;r.updateDetails(k,A);try{if(!s){const a=await j.getTcbFuncInfo({namespace:g,functionName:i});if(a.Status===m.FUNCTION_STATUS.Updating)throw new Error('\u68C0\u6D4B\u5230\u4E0E\u6B63\u5728\u8FDB\u884C\u4E2D\u7684\u53E6\u4E00\u4E2A\u8BE5\u4E91\u51FD\u6570\u7684\u66F4\u65B0\u8BF7\u6C42\u51B2\u7A81\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5');A=u,r.updateDetails(k,A);let b=v?'TRUE':'FALSE';if(p(v?'tcb_upload_func_install_dependency':'tcb_upload_func_full',!0),b!==a.InstallDependency){n&&(A=w,r.updateDetails(k,A));await j.updateTcbFuncConfig({namespace:g,functionName:i,config:{InstallDependency:b}})}}A=y,r.updateDetails(k,A);const a=await j.uploadTcbFunc({functionName:i,dirPath:l,runtime:o,namespace:g,installDependency:v,onStatusUpdate:(a)=>{switch(a){case m.IDE_UPLOAD_STATUS.COMPRESSING:{A=x,r.updateDetails(k,A);break}case m.IDE_UPLOAD_STATUS.UPLOADING:{A=z,r.updateDetails(k,A);break}}}}),b=L(a);r.updateDetails(k,`${D}\n${b}`),A=v?C:B;const d=+new Date;return await N({namespace:g,functionName:i,onStatusUpdate:(a)=>{switch(a){case m.FUNCTION_STATUS.Creating:{r.updateDetails(k,B);break}case m.FUNCTION_STATUS.Updating:{v?r.updateDetails(k,C):r.updateDetails(k,B);break}}}}),v&&p('perf_biz_tcb_upload_func_wait_online_dep',!1,(+new Date-d).toFixed(0).toString()),A=D,r.updateDetails(k,A),q&&I({showTips:!1,writeFile:!1})(c,f),v?p('perf_biz_tcb_upload_func_online_dep',!1,(+new Date-e).toFixed(0).toString()):p('perf_biz_tcb_upload_func_full_upload',!1,(+new Date-e).toFixed(0).toString()),!0}catch(a){throw console.error('uploadTcbFunc fail',a),a&&'ResourceNotFound.FunctionName'===a.rawErrCode&&I({showTips:!1,writeFile:!1})(c,f),a}}const i=b.basename(a.dirPath),k=`upload-${i}-${+new Date}`;try{r.add({id:k,name:e.config.TCB_UPLOAD_FUNCTION.format(i),type:'uploadTcbFunction',progressIndeterminate:!0,status:'pending'});const a=await g();a?r.markSuccess(k):r.deleteProgress(k)}catch(a){r.updateDetails(k,a.toString()),r.markFail(k,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG})}}},P=(d)=>{return async(f,h)=>{const i=d.namespace||(await F(f,h));if(i){const h=`downloadTcbFunc-${+new Date}`;r.add({id:h,name:e.config.TCB_DOWNLOAD_FUNCTION.format(d.functionName),type:'downloadTcbFunc',progressIndeterminate:!0,status:'pending'});try{let e=await l.getFunctionData({functionName:d.functionName,forceUpdate:!0,namespace:i});if(d.writeFile)for(var j in e){let f=b.join(d.dirPath,j),g=b.dirname(f);c.sync(g),a.writeFileSync(f,e[j])}f({type:g.TCB_SET_FILE,data:{functionName:d.functionName,fileList:Object.keys(e),namespace:i}}),r.markSuccess(h)}catch(a){r.updateDetails(h,a.toString()),r.markFail(h,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG})}}}};module.exports={getEnvList:G,selectEnv:H,getTcbFuncList:I,uploadTcbFunc:O,consoleCommand:J,showActionMsg:(a)=>{return{type:g.TCB_SCF_INFO,data:{show:!0,message:a}}},setConfirmInfo:(a)=>{return{type:g.TCB_SCF_INFO,data:a}},showConsoleAddSCF:()=>{return async(a,b)=>{const c=n.getCurrentTcbInfo(),d=await F(a,b);if(d){let b=i.get(k.WINDOW_REGISTRY.CLOUD_CONSOLE);b?b.focus():a({type:g.WINDOW_SET_CLOUD,data:{console:{show:!0}}}),a(J({command:'SHOW_CREATE_SCF',data:{namespace:d,envId:c.currentEnv&&c.currentEnv.id}}))}}},downloadTcbFunc:P,downloadAllTcbFunc:(d)=>{return async(f,h)=>{const i=h(),j=i.project.current.cloudfunctionRoot,k=await F(f,h);if(k){const n=`downloadAllTcbFunc-${+new Date}`;r.add({id:n,name:e.config.TCB_DOWNLOAD_ALL_FUNCTION,type:'downloadAllTcbFunc',progressIndeterminate:!0,status:'pending'});let i=[];try{const o=(await I(d)(f,h))||[];for(let h,p=0,s=o.length;p<s;p++){h=o[p],r.updateDetails(n,e.config.TCB_DOWNLOAD_FUNCTION.format(h.FunctionName));try{let e=await l.getFunctionData({functionName:h.FunctionName,forceUpdate:d.forceUpdate,namespace:k});if(d.writeFile){let d=b.join(j,h.FunctionName);for(var m in e){let f=b.join(d,m),g=b.dirname(f);c.sync(g),a.writeFileSync(f,e[m])}}f({type:g.TCB_SET_FILE,data:{functionName:h.FunctionName,fileList:Object.keys(e),namespace:k}})}catch(a){i.push(a.toString()),r.updateDetails(n,i.join('\n')),r.markFail(n,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG})}}0===i.length&&r.markSuccess(n)}catch(a){r.updateDetails(n,a.toString()),r.markFail(n,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG})}}}},setLoading:(a)=>{return{type:g.TCB_SET_LOADING,data:a}},uploadTcbFunctions:(a)=>{return async(b,c)=>{const d=a.dirPaths;for(let e,f=0;f<d.length;f++)e=d[f],await O({showTips:a.showTips,syncFunctions:!1,dirPath:e})(b,c);I({showTips:!1,writeFile:!1})(b,c)}},uploadTcbFuncTriggers:(c)=>{return async(d,f)=>{const g=await F(d,f);if(!g)return;const{dirPath:h,showTips:i,syncFunctions:k}=c,l=b.basename(h),m=`deleteTcbFuncTriggers-${+new Date}`;r.add({id:m,name:e.config.TCB_UPLOAD_TRIGGERS.format(l),type:'deleteTcbFuncTriggers',progressIndeterminate:!0,status:'pending'});let n=t;try{n=v,r.updateDetails(m,n);const c=b.join(h,'config.json');if(!a.existsSync(c))throw new Error('\u672A\u627E\u5230\u4E91\u51FD\u6570\u914D\u7F6E\u6587\u4EF6 config.json');let d=a.readFileSync(c,'utf8');try{d=JSON.parse(d)}catch(a){throw new Error(`JSON 解析 config.json 失败，请确认文件是标准 JSON 格式, ${a}`)}if(!d.triggers||!Array.isArray(d.triggers))throw new Error('\u8BF7\u786E\u8BA4 config.json \u4E2D\u5305\u542B\u5408\u6CD5\u7684 triggers \u5B57\u6BB5');n=A,r.updateDetails(m,n),await j.batchCreateTcbFuncTriggers({namespace:g,functionName:l,count:d.triggers.length,triggers:d.triggers.map((a,b)=>{if('Object'===!Object.prototype.toString.call(a).slice(8,-1))throw new Error(`triggers[${b}] 定义必须是合法对象`);if(!a.name)throw new Error(`triggers[${b}] 缺少必填参数 name`);if(!a.type)throw new Error(`triggers[${b}] 缺少必填参数 type`);switch(a.type){case'timer':{if(!a.config)throw new Error(`triggers[${b}] 缺少必填参数 config`);break}default:}return{TriggerName:a.name,Type:a.type,TriggerDesc:a.config}})}),n=D,r.updateDetails(m,''),r.markSuccess(m)}catch(a){console.error('uploadTcbFuncTriggers fail',a),r.updateDetails(m,a.toString()),r.markFail(m,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG})}}},deleteTcbFuncTriggers:(a)=>{return async(c,d)=>{const f=`deleteTcbFuncTriggers-${+new Date}`;try{const g=await F(c,d);if(!g)return;const{dirPath:h}=a,i=b.basename(h);r.add({id:f,name:e.config.TCB_DELETE_TRIGGERS.format(i),type:'deleteTcbFuncTriggers',progressIndeterminate:!0,status:'pending'}),await j.batchCreateTcbFuncTriggers({namespace:g,functionName:i,count:0,triggers:[]}),r.markSuccess(f)}catch(a){console.error('deleteTcbFuncTriggers fail',a),r.updateDetails(f,a.toString()),r.markFail(f,{buttonsTemplate:q.TEMPLATE.PROGRESS_DIALOG})}}},downloadTcbFunctions:(a)=>{return async(c,d)=>{for(let e,f=0;f<a.functionNames.length;f++)e=a.functionNames[f],await P(_extends({},a,{dirPath:b.join(a.dirPath,e),functionName:e}))(c,d)}},setCurrentEnv:(a)=>{return async(b)=>{const c=n.getCurrentTcbInfo();let d=c.envList;if(0>=d.length){let a=await j.getEnvList();b({type:g.TCB_SET_SCF_LIST,data:a.env_list}),d=a.env_list}const e=d.findIndex((b)=>{return b.namespace==a});-1!=e&&b(H(e))}}}}(require('lazyload'),require);