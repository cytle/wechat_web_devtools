;!function(require, directRequire){;'use strict';const path=require('path'),fs=require('fs'),os=require('os'),checkAppConfig=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),vendorManager=require('./d28a711224425b00101635efe1034c99.js'),{spawn}=require('child_process'),{TRANS_WXML_JS_ERR}=require('./949d8235c744ced2a80121e4dba34c28.js'),report=require('./da7c31daaf542cf1796023d8e344b98a.js'),contentWatcher=require('./162bf2ee28b76d3b3d95b685cede4146.js'),checkCustomComponent=require('./6b5520e429c60abf5d2f924c0fa05fd0.js'),tools=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),locales=require('./common/locales/index.js'),compileCache=require('./2e9637e8a0816a626f7db9a0dee5efe8.js'),fileRules=require('./1c8a8c710417d102ab574145dc51b4b0.js'),dirConfig=require('./92320c1386e6db6a6f2556736a9bc280.js'),topTools=require('./84b183688a46c9e2626d3e6f83365e13.js'),filterFiles=(a,b,c,d)=>{const e=a.packOptions&&a.packOptions.ignore||[],f=(a)=>!fileRules.isFileIgnored(a,e);let g=b.getAllWXMLFiles().filter(f),h=b.getAllWXSFiles().filter(f);if(c.subPackages){const a=g.filter((a)=>{let b=!0;return c.subPackages.forEach((c)=>{0===a.indexOf(c.root)&&(b=!1)}),b}),b=h.filter((a)=>{let b=!0;return c.subPackages.forEach((c)=>{0===a.indexOf(c.root)&&(b=!1)}),b});d?(g=a.concat(g.filter((a)=>0===a.indexOf(d.root))),h=b.concat(h.filter((a)=>0===a.indexOf(d.root)))):(g=a,h=b)}return{wxmlFiles:g,wxsFiles:h}};function shouldUseConfigFile(a){if('darwin'!==process.platform){if(128<a.length)return!0;for(const b of a)if(1e4<b.length)return!0}return!1}async function wxmlToJS(a,b){return new Promise(async(c,d)=>{const e=await contentWatcher(a),{appConfig:f,config:g,type:h}=b,{wxmlFiles:i,wxsFiles:j}=filterFiles(a,e,f,g);let k=i.concat(j),l=!1;j&&0<j.length&&(l=!0,report('wxs_compile',!0)),k=k.map((a)=>`./${a}`);const m=g?`$${new Buffer(g.root).toString('hex')}`:'$gwx',n='>_<'+Date.now()%1e4;let o=[];try{o=await checkCustomComponent.getCompileConfig(a,f,g)}catch(a){return d(a)}const p=['-d',h,o.join(n),'--split',n].concat(k).concat(['-gn',m]),q=path.join(os.tmpdir(),topTools.random()),r=shouldUseConfigFile(p);r&&fs.writeFileSync(q,p.join('\n'));const s=vendorManager.getWXMLParsePath(),t=spawn(s,r?['--config-path',topTools.normalizePath(q)]:p,{cwd:e.srcPath}),u=[],v=[];t.on('close',(b)=>{if(r&&fs.unlinkSync(q),0===b){const a=Buffer.concat(u).toString();return c({code:a,name:m})}l&&report('wxs_compile_fail',a.appid);const e=Buffer.concat(v).toString(),f=new Error(locales.config.COMPILE_WXML_ERROR_CONSOLE);return f.code=TRANS_WXML_JS_ERR,f.msgForConsole=e,d(f)}),t.stdout.on('data',(a)=>{u.push(a)}),t.stderr.on('data',(a)=>{v.push(a)})})}async function transWXMLToJS(a,b={}){const c=await checkAppConfig(a),{app:d,page:e,cut:f}=b;let g,h='main';if(!d){if(g=tools.checkIsInSubPackage(c,e)||'',!g)return{code:'',name:'$gwx'};h=`sub_${g.root}`}await compileCache.init(a);const i=f?compileCache.CACHE_KEYS.WXML_CUT:compileCache.CACHE_KEYS.WXML_COMPLETE,j=h;let k=compileCache.get(i,j);return k||(k=await wxmlToJS(a,{appConfig:c,config:g,type:f?'-xc':'-cc'}),compileCache.set(i,j,k)),k}module.exports=transWXMLToJS;
;}(require("lazyload"), require);
