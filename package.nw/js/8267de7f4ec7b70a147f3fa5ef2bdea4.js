;!function(require, directRequire){;'use strict';const _=require('lodash'),path=require('path'),fs=require('fs'),tools=require('./84b183688a46c9e2626d3e6f83365e13.js'),locales=require('./common/locales/index.js'),checkExtJSON=require('./551bb965e1f344281d555a429cd2140c.js'),compileTypeConfig=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),contentWatcher=require('./162bf2ee28b76d3b3d95b685cede4146.js'),C=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),parseErr=require('./6238a86bb7a55c11aa0f9eb335d0f34c.js'),commonChecker=require('./464e9598eb5c203da6b41e702e422c70.js'),weappConfig=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),T=directRequire('./8a667b7a4c0cf964060daa2612e47d49.js'),validateType=directRequire('./445cba00a07f842db3284acee321797b.js'),compileCache=require('./2e9637e8a0816a626f7db9a0dee5efe8.js'),siteMapValidateType=directRequire('./094dea68e3755371d832f149288247f1.js'),TABBAR_ICON_WHITE_LIST=['.png','.jpg','.jpeg'],appErrcodeConfig=require('./949d8235c744ced2a80121e4dba34c28.js');function throwError(a,b){const c=new Error(a);throw c.code=b||appErrcodeConfig.APP_JSON_CONTENT_ERR,c}function checkPagePath(a,b){'string'!==tools.getType(a)&&throwError(locales.config.JSON_CONTENT_SHOULD_BE.format([`${b}`,'string'])),0<=a.indexOf('\\')&&throwError(locales.config.JSON_SHOULD_NOT_CONTAIN.format([`${b}`,'\\'])),0===a.indexOf('.')&&throwError(locales.config.JSON_SHOULD_NOT_START_WITH.format([`${b}`,'.'])),0===a.indexOf('/')&&throwError(locales.config.JSON_SHOULD_NOT_START_WITH.format([`${b}`,'/']))}function checkPlugins(a,b){function c(b,c){return a.compileType!==compileTypeConfig.plugin&&'dev'===b.version?void d.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format([`${c}["version"]`,'dev'])+'\n'+locales.config.PLEASE_CHOOSE_PLUGIN_MODE):a.compileType===compileTypeConfig.plugin&&'dev'===b.version&&b.provider!==a.appid?void d.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`${c}["provider"]`,a.appid])):'dev'===b.version||/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/.test(b.version)||void d.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`${c}["version"]`,locales.config.TRIPLE_NUMBER_DOT]))}const d=[],e=b.plugins||{},f={};for(const g in e){const a=e[g];c(a,`appJSON["plugins"]["${g}"]`)&&(f[a.provider]?d.push(locales.config.PLUGINS_MULTI_PROVIDER.format(a.provider)):f[a.provider]={provider:a.provider,version:a.version,alias:g})}if(b.subPackages&&b.subPackages.forEach((a,b)=>{if(a.plugins){const g=`appJSON["subPackages"][${b}]`;for(const b in a.plugins){const h=a.plugins[b];(e[b]&&d.push(locales.config.JSON_PLUGIN_SHOULD_NOT_IN_SUBPACKAGE.format([`plugins ${b}`,g])),!!c(h,`${g}["plugins"]["${b}"]`))&&(f[h.provider]?d.push(`${g}["plugins"]["${b}"]["provider"] ${locales.config.ALREADY_EXISTS}`):f[h.provider]={provider:h.provider,version:h.version,alias:h})}}}),0<d.length){const a=new Error(d.join('\n'));throw a.code=appErrcodeConfig.APP_JSON_CONTENT_ERR,a}}function checkSubpackage(a,b,c){const d=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),e=Object.assign({},d.setting,a.runtimeAttr&&a.runtimeAttr.setting);let f='appJSON["subPackages"]';c.subpackages&&(f='appJSON["subpackages"]',c.subPackages=c.subpackages,delete c.subpackages);const g=[],h=c.pages||[];let j=!1;if(c.subPackages){c.subPackages.length>e.MaxSubPackageLimit&&throwError(locales.config.EXCEED_LIMIT.format([f,e.MaxSubPackageLimit]));const a={},d={};c.subPackages.forEach((e,k)=>{if(checkPagePath(e.root,`${f}[${k}]["root"]`),e.root===C.MINI_PROGRAM_MAIN_PACKAGE_ROOT)return void g.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format([`${f}[${k}]["root"]`,C.MINI_PROGRAM_MAIN_PACKAGE_ROOT]));if(e.name){if(e.name===C.MINI_PROGRAM_MAIN_PACKAGE_ROOT)return void g.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format([`${f}[${k}]["name"]`,C.MINI_PROGRAM_MAIN_PACKAGE_ROOT]));if(d[e.name])return void g.push(locales.config.JSON_SUBPACKAGE_EXIST.format([`${f}[${k}]["name"]`]));d[e.name]=!0}if(e.root=tools.normalizePath(e.root+'/'),a[e.root])return void g.push(locales.config.JSON_SUBPACKAGE_EXIST.format([`${f}[${k}]["root"]`]));if(a[e.root]=!0,!fs.existsSync(path.join(b,e.root)))return void g.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`${f}[${k}]["root"]`,locales.config.DIRECTORY]));const i=fs.statSync(path.join(b,e.root));if(!i.isDirectory())return void g.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`${f}[${k}]["root"]`,locales.config.DIRECTORY]));h.forEach((a)=>{0===a.indexOf(e.root)&&g.push(locales.config.JSON_PAGE_SHOULD_NOT_IN_SUBPACKAGE.format([`pages ${a}`,`${f}[${k}]`]))});const l={};for(let a=0,d=e.pages.length;a<d;a++){const d=e.pages[a];checkPagePath(d,`${f}[${k}]["pages"][${a}]`);const h=tools.normalizePath(path.posix.join(e.root,d));if(l[h]){g.push(locales.config.JSON_PAGES_REPEAT.format([`${f}[${k}]`,d]));continue}l[h]=!0,j||h!==c.entryPagePath||(j=!0),checkPageExist(b,h,[`${f}[${k}]`,'pages',d])}}),0<g.length&&throwError(g.join('\n')),c.subPackages.forEach((a,b)=>{let d=-1;const e='/'+a.root;if(c.subPackages.forEach((a,c)=>{if(c!==b&&a.root){const b='/'+a.root;0===e.indexOf(b)&&(d=c)}}),-1!==d)return void g.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format([`${f}[${b}]["root"]`,`${f}[${d}]["root"] 的子目录`]))}),0<g.length&&throwError(g.join('\n'))}return j}function checkPreloadRule(a){if(a.preloadRule&&a.subPackages){const b=[];let c=[...a.pages];const d={},e={};for(let b=0,f=a.subPackages.length;b<f;b++){const f=a.subPackages[b],g=f.pages.map((a)=>{return path.posix.join(f.root,a)});d[f.root]=!0,f.name&&(e[f.name]=!0),c=c.concat(g)}for(const f in a.preloadRule){if(-1===c.indexOf(f)){b.push(locales.config.NOT_FOUND.format(`preloadRule['${f}'] ${locales.config.PAGE_PATH}`));continue}const g=a.preloadRule[f];for(let a,c=0,h=g.packages.length;c<h;c++)if((a=g.packages[c],a!==C.MINI_PROGRAM_MAIN_PACKAGE_ROOT)&&!e[a]&&(a=tools.normalizePath(a+'/'),!d[a])){b.push(locales.config.NOT_FOUND.format(`appJSON["preloadRule"]["${f}"]["packages"][${c}]: ${a}`));continue}}0<b.length&&throwError(b.join('\n'))}}async function checkTabbar(a,b){const c=await contentWatcher(a),d=c.srcPath,e=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),f=Object.assign({},e.setting,a.runtimeAttr&&a.runtimeAttr.setting),g=b.pages,h=b.tabBar,j=[];if(h){h.list.length<f.MinTabbarCount&&throwError(locales.config.JSON_TABBAR_AT_LEAST.format(f.MinTabbarCount)),h.list.length>f.MaxTabbarCount&&throwError(locales.config.JSON_TABBAR_AT_MOST.format(f.MaxTabbarCount));for(let a=0;a<h.list.length;a++){const b=h.list[a],c=b.pagePath;if(checkPagePath(c,`tabBar[${a}].pagePath`),!c){j.push(locales.config.JSON_TABBAR_PATH_EMPTY.format(a));continue}if(0>g.indexOf(c)){j.push(`appJSON["tabBar"][${a}]["pagePath"] "${c}" 需在 pages 数组中`);continue}2<=c.split('?').length&&j.push(locales.config.JSON_TABBAR_PATH_NOT_CONTAIN.format([a,'?'])),2<=c.split('.').length&&j.push(locales.config.JSON_TABBAR_PATH_NOT_CONTAIN.format([a,'.']));const e=[];if(b.iconPath){const a=path.join(d,b.iconPath);b.iconPath=path.relative(d,a),e.push({name:'iconPath',path:a})}if(b.selectedIconPath){const a=path.join(d,b.selectedIconPath);b.selectedIconPath=path.relative(d,a),e.push({name:'selectedIconPath',path:a})}e.forEach((b)=>{if(!fs.existsSync(b.path))return void j.push(locales.config.JSON_TABBAR_ICON_NOT_FOUND.format([a,b.name]));const c=fs.statSync(b.path);if(c.isDirectory())return void j.push(locales.config.JSON_TABBAR_ICON_NOT_DIR.format([a,b.name]));c.size>1024*f.MaxTabbarIconSize&&j.push(locales.config.JSON_TABBAR_ICON_MAX_SIZE.format([a,b.name,f.MaxTabbarIconSize]));const d=path.extname(b.path);0>TABBAR_ICON_WHITE_LIST.indexOf(d)&&j.push(locales.config.JSON_TABBAR_ICON_EXT.format([a,b.name,TABBAR_ICON_WHITE_LIST.join('\u3001')]))})}}0<j.length&&throwError(j.join('\n'),appErrcodeConfig.APP_JSON_CONTENT_ERR)}function checkNavigateToMiniProgramAppIdList(a,b){const c=[];if(b.navigateToMiniProgramAppIdList){const d=a.runtimeAttr&&a.runtimeAttr.appType||weappConfig.APP_TYPE.NORMAL;if(d!==weappConfig.APP_TYPE.NATIVE){const d=a.runtimeAttr&&a.runtimeAttr.setting&&a.runtimeAttr.setting.NavigateMiniprogramLimit||weappConfig.setting.NavigateMiniprogramLimit;b.navigateToMiniProgramAppIdList.length>d&&c.push(locales.config.EXCEED_LIMIT.format([`navigateToMiniProgramAppIdList`,d]))}}0<c.length&&throwError(c.join('\n'))}async function mergeExtJSON(a,b){const c=await checkExtJSON(a);if(c)for(const a in c){if('__warning__'==a){b.__warning__=b.__warning__?`${b.__warning__}、${c.__warning__}`:c.__warning__;continue}'extPages'!=a&&('object'===tools.getType(c[a])?'object'===tools.getType(b[a])?b[a]=Object.assign({},b[a]||{},c[a]):b[a]=Object.assign({},c[a]):b[a]=c[a])}}function checkWorkers(a,b){const{workers:c}=b;if(c){checkPagePath(c,'workers');const b=path.join(a,c);fs.existsSync(b)||throwError(locales.config.JSON_CONTENT_SHOULD_BE.format([`workers`,locales.config.DIRECTORY]));const d=fs.statSync(b);d.isDirectory()||throwError(locales.config.JSON_CONTENT_SHOULD_BE.format([`workers`,locales.config.DIRECTORY]))}}function checkWindow(a){if(a.window){const b=[];a.window.backgroundColorTop&&(a.window.backgroundColor=a.window.backgroundColorTop),0<b.length&&throwError(b.join('\n'))}}function getAllPages(a){const b=[...a.pages];if(a.subPackages)for(const c of a.subPackages)for(const a of c.pages)b.push(tools.normalizePath(path.posix.join(c.root,a)));return b}function checkMimeTypeDeclarations(a,b){if(!a.mimeTypeDeclarations)return;const c=Object.keys(a.mimeTypeDeclarations),d=[],e={};for(const f of c){const c=tools.escapeQuot(f,'\'');if(-1===b.indexOf(f)){d.push(locales.config.JSON_ENTRY_PAGE_PATH_NOT_FOUND.format(['appJSON["pages"]\u3001appJSON["subPackages"]',`appJSON["mimeTypeDeclarations"]["${c}"]`]));continue}const g=a.mimeTypeDeclarations[f];g.forEach((a)=>{return e[a]?void d.push(locales.config.JSON_CONTENT_REPEAT.format([a,`appJSON["mimeTypeDeclarations"]["${c}"]、appJSON["mimeTypeDeclarations"]["${e[a]}"]`])):void(e[a]=c)})}0<d.length&&throwError(d.join('\n'))}function checkOpenLocationPagePath(a,b){a.openLocationPagePath&&(checkPagePath(a.openLocationPagePath,'openLocationPagePath'),checkPageExist(b,a.openLocationPagePath,['app.json','openLocationPagePath',a.openLocationPagePath]))}function checkPageExist(a,b,c){fs.existsSync(path.join(a,`${b}\.wxml`))||throwError(locales.config.JSON_PAGE_WXML_NOT_EXISTS.format(c),appErrcodeConfig.APP_JSON_WXML_NOT_FOUND),fs.existsSync(path.join(a,`${b}\.js`))||throwError(locales.config.JSON_PAGE_JS_NOT_EXISTS.format(c),appErrcodeConfig.APP_JSON_JS_NOT_FOUND)}function checkFunctionalPages(a){if(a.functionalPages&&'object'!==tools.getType(a.functionalPages)){const b='app.json \u4E2D\u7684 functionalPages \u914D\u7F6E\u9700\u8981\u66F4\u65B0\uFF0C\u8BE6\u89C1\u6587\u6863: https://developers.weixin.qq.com/miniprogram/dev/framework/plugin/functional-pages.html';a.__warning__=a.__warning__?`${a.__warning__}\n${b}`:b}}function checkSitemapLocation(a,b){if(!a.sitemapLocation)return;checkPagePath(a.sitemapLocation,'sitemapLocation');const c=path.join(b,a.sitemapLocation);fs.existsSync(c)||throwError(locales.config.JSON_PAGE_FILE_NOT_EXISTS.format(['app.json','sitemapLocation',a.sitemapLocation,'JSON']));const d=fs.statSync(c);d.isDirectory()&&throwError(locales.config.JSON_PAGE_FILE_NOT_EXISTS.format(['app.json','sitemapLocation',a.sitemapLocation,'JSON']));const e=path.extname(c);'.json'!==e&&throwError(locales.config.JSON_PAGE_FILE_NOT_EXISTS.format(['app.json','sitemapLocation',a.sitemapLocation,'JSON']));const f=c.replace(/\.json$/,''),g=fs.readFileSync(c,'utf8');let h={};try{h=JSON.parse(g)}catch(a){const b=parseErr.parseJsonParseErr({data:g,error:a}),c=new Error(b);throw c.path=f,c.code=appErrcodeConfig.PAGES_JSON_PARSE_ERR,c}try{siteMapValidateType.check(h)}catch(a){throw a.path=f,a.code=appErrcodeConfig.PAGES_JSON_PARSE_ERR,a}}async function checkAppJSON(a){const b=await contentWatcher(a),c=b.srcPath,d='app.json';let f='';const e=[];try{f=b.getFile(d)}catch(a){const b=new Error(locales.config.FILE_NOT_FOUND.format(d));throw b.code=appErrcodeConfig.APP_JSON_READ_ERR,b.ext=a.toString(),b}let g={};try{g=JSON.parse(f)}catch(a){const b=parseErr.parseJsonParseErr({data:f,error:a});throwError(b,appErrcodeConfig.APP_JSON_PARSE_ERR)}try{validateType.check(g)}catch(a){throwError(`appJSON${a.message}`)}const h=T.invalidKeys(validateType,g);if(h){const a=h.map((a)=>{return`appJSON${a}`});g.__warning__=locales.config.INVALID.format(a.join('\u3001'))}g.entryPagePath&&checkPagePath(g.entryPagePath,'entryPagePath');const j=g.pages||[];0===j.length&&throwError(locales.config.ENTRANCE_NOT_FOUND.format(JSON.stringify(j)),appErrcodeConfig.APP_JSON_ENTRANCE_NOT_FOUND_ERR);let k=!g.entryPagePath;const l={};for(let b=0;b<j.length;b++){const a=j[b];checkPagePath(a,`pages[${b}]`),l[a]&&throwError(locales.config.JSON_PAGES_REPEAT.format([d,a]),appErrcodeConfig.APP_JSON_PAGES_ERR),l[a]=!0,k||a!==g.entryPagePath||(k=!0),checkPageExist(c,a,[d,'pages',a])}const i=checkSubpackage(a,c,g);k=k||i,k||throwError(locales.config.JSON_ENTRY_PAGE_PATH_NOT_FOUND.format(['pages\u3001subPackages','entryPagePath']),appErrcodeConfig.APP_JSON_PAGES_ERR),await checkTabbar(a,g),delete g.extAppid,await mergeExtJSON(a,g),checkPlugins(a,g),checkPreloadRule(g),checkWorkers(c,g),checkWindow(g),checkFunctionalPages(g);const m=getAllPages(g);return checkMimeTypeDeclarations(g,m),checkOpenLocationPagePath(g,c),checkSitemapLocation(g,c),g.usingComponents&&commonChecker.checkUsingComponents(g,{msg:e,filePath:'app.json',JSON_PARSE_ERR:appErrcodeConfig.APP_JSON_PARSE_ERR}),checkNavigateToMiniProgramAppIdList(a,g),0<e.length&&throwError(e.join('\n')),g}async function checkAppJSONRunner(a){await compileCache.init(a);const b=compileCache.CACHE_KEYS.JSON_APP_JSON;let c=compileCache.get(b);if(c)return _.cloneDeep(c);try{return c=await checkAppJSON(a),compileCache.set(b,c),_.cloneDeep(c)}catch(a){throw a.code||(a.code=appErrcodeConfig.APP_JSON_CONTENT_ERR),a}}module.exports=checkAppJSONRunner;
;}(require("lazyload"), require);
