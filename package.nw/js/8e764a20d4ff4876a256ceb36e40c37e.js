;!function(require, directRequire){;"use strict";const tslib_1=require("tslib"),React=require("react"),cssConfig=require('./3b5f8e2469c474c8d433c1c6926d8999.js'),urlConfig=require('./f171257bbcaef547a3cf27266ccb0db2.js'),tools=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),toolbarActions=require('./fc137838572a83604db39acff8e909e0.js'),clickkeyConfig=require('./eadce02c750c875a10680bcfedadec88.js'),noticeCenterDB=require('./948f9199c1cd0ba6cb9d19ad84972410.js'),messageConfig=require('./bcb48ae14d243711d3b31cb0f602d209.js'),menuActions=require('./25d0beb4120ce2acafb4e03b95444fda.js'),userActions=require('./9c906d27ca74e18d0deaaa231e71fdfa.js'),projectActions=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),LoginQRCode=require('./f2b0fd116ee25849124e867e0da34f23.js'),constantsConfig=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),infoActions=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),log=require('./72653d4b93cdd7443296229431a7aa9a.js'),report=require('./da7c31daaf542cf1796023d8e344b98a.js'),request=require('./15ba1827c7f6564a45df6bd44da3a977.js'),moment=require("moment"),locales=require('./common/locales/index.js'),NoticeItem=require('./1690320dea21ebee07b435c0260f71ca.js'),{connect}=require("react-redux"),mapStateToProps=(a)=>{let b=!1;if(a.user){const c=a.user;if(c){const a=+new Date;a<=c.signatureExpiredTime&&(b=!0)}}return{project:a.project.current,loginStatus:a.user.loginStatus,nickName:b?a.user.nickName:locales.config.NOT_LOGGED}},mapDispatchToProps=(a)=>({requestProjectAttr:tools.bindActionCreators(projectActions.requestProjectAttr,a),showError:tools.bindActionCreators(infoActions.showError,a),toggleClickKey:tools.bindActionCreators(toolbarActions.toggleClickKey,a),loginExpired:tools.bindActionCreators(userActions.loginExpired,a),loginSuccess:tools.bindActionCreators(userActions.loginSuccess,a)}),formateTime=(a)=>moment(new Date(1e3*a)).calendar(),MsgDBTypeWording={1:locales.config.TOOL_REMINDER,2:locales.config.SYSTEM_NOTIFICATION,3:locales.config.COMMUNITY_NOTIFICATION,4:locales.config.TENCENT_CLOUD_NOTIFICATION,5:locales.config.MONITORING_NOTIFICATION};let NoticeCenter=class extends React.Component{constructor(a){super(a),this.onContainerClick=(a)=>{a.stopPropagation()},this.onClose=(a)=>{a.stopPropagation(),this.props.toggleClickKey(clickkeyConfig.NONE)},this.onScroll=()=>{this.scrollTimer&&clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(()=>{const a=this.listContainer.getBoundingClientRect();500>a.height+a.top&&noticeCenterDB.next().then((a)=>{this.setState({list:this.state.list.concat(a)})}).catch((a)=>{log.error(`get next page catch ${a}`)})},250)},this.onLogout=()=>{this.setState({loginQRCodeShow:!0})},this.state={list:[],loginQRCodeShow:a.showQRCode||a.loginStatus===constantsConfig.LOGIN_STATUS.EXPIRED},this.scrollTimer=null}componentDidMount(){noticeCenterDB.open().then(()=>noticeCenterDB.getFirstPage()).then((a)=>{this.setState({list:a})}).catch((a)=>{log.error(`get first page catch ${a}`)})}componentWillReceiveProps(a){a.loginStatus!==this.props.loginStatus&&(a.loginStatus===constantsConfig.LOGIN_STATUS.SUCCESS?setTimeout(()=>{this.onLoginSuccess()}):a.loginStatus===constantsConfig.LOGIN_STATUS.EXPIRED&&this.setState({loginQRCodeShow:!0}))}componentWillUnmount(){noticeCenterDB.close()}onLoginSuccess(){this.props.project&&this.props.requestProjectAttr(!1),this.props.toggleClickKey(clickkeyConfig.NONE)}onLinkClick(a){if(a.link){try{a.filter_buffer&&a.filter_buffer.msg_job_id&&request({url:urlConfig.reportTipsClick,method:"post",body:JSON.stringify({job_id:a.filter_buffer.msg_job_id}),needToken:1}).then((a)=>{global.appConfig.isDev&&console.log("report tips click res",a)}).catch((a)=>{log.error(`report tips click error: ${a.toString()}`)})}catch(a){}a.type===messageConfig.DBType.bbs?(menuActions.BBS(a.link,constantsConfig.IDE_SCENE.MESSAGE_CENTER),report("weapp_message_center_bbsurl",this.props.project.appid)):a.type===messageConfig.DBType.alarm?nw.Shell.openExternal(a.link):a.type===messageConfig.DBType.system?nw.Shell.openExternal(a.link):a.type===messageConfig.DBType.tools&&nw.Shell.openExternal(`https://developers.weixin.qq.com/miniprogram/dev/devtools/uplog.html`)}}render(){const a=this.props;return React.createElement("div",{className:"ui-popover",style:{left:10},onClick:this.onContainerClick,onScroll:this.onScroll},React.createElement("div",{className:"notification"},React.createElement("div",{className:"notification-hd ui-flex"},React.createElement("h3",{className:"notification-title ui-flex-item"},locales.config.PERSONAL_CENTER),React.createElement("div",{className:"notification-hd-ext",onClick:this.onClose},React.createElement("i",{className:"ui-icon-close"}))),React.createElement("div",{className:"notification-bd"},React.createElement("div",{className:"ui-flex notification-account"},React.createElement("div",{className:"ui-flex-item"},React.createElement("h4",{className:"notification-account-name"},a.nickName)),React.createElement("div",{className:"notification-toggle",onClick:this.onLogout},React.createElement("i",{className:"ui-icon-toggle"}))),this.state.loginQRCodeShow?React.createElement(LoginQRCode,{from:"noticecenter",onLoginSuccess:a.loginSuccess}):null,React.createElement("div",{className:"notification-list",style:this.state.loginQRCodeShow?cssConfig.displayNone:{},ref:(a)=>{this.listContainer=a}},0===this.state.list.length?React.createElement("div",{className:"notification-item ui-flex"},React.createElement("div",{className:"notification-content"},React.createElement("div",{className:"notification-content-empty"},React.createElement("i",{className:"ui-icon-cup"}),React.createElement("p",null,locales.config.NO_NEW_MESSAGES)))):this.state.list.map((a)=>React.createElement(NoticeItem,{key:a.id,type:MsgDBTypeWording[a.type],content:`${a.content}`,link:a.type===messageConfig.DBType.tools?locales.config.GO_TO_VIEW:a.link?locales.config.GO_TO_VIEW:"",time:formateTime(a.timestamp),onLinkClick:this.onLinkClick.bind(this,a)}))))))}};NoticeCenter=tslib_1.__decorate([locales.mixin],NoticeCenter),module.exports=connect(mapStateToProps,mapDispatchToProps)(NoticeCenter);
;}(require("lazyload"), require);
