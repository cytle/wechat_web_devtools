'use strict';!function(require,directRequire){const a=require('react'),b=require('querystring'),c=require('redux'),d=require('./a78e6d6a87de1708226375ca4c320d76.js'),e=require('./6b70fc1a2dbee232784064c344aaaf2b.js'),f=require('./e3681b47a6ce46a8998b8cdff40bdb12.js'),g=require('./72653d4b93cdd7443296229431a7aa9a.js'),h=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),i=require('./ff946754202ecf377034d29daac7c8d9.js'),j=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),k=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),{connect:l}=require('react-redux'),{validType:m,tokenManager:n}=require('./dc244a5ba483ad6e0acd267d3b91b282.js');class o extends a.Component{constructor(a){super(a)}componentDidMount(){this._onNativeViewMessage=this.onNativeViewMessage.bind(this),this.insertView(this.props.node)}componentWillReceiveProps(a){a.operateNativeView!=this.props.operateNativeView&&a.operateNativeView.id==a.node.id&&a.operateNativeView.name==a.node.name&&setTimeout(()=>{this.operateNativeView(this.props.operateNativeView)}),a.node!=this.props.node&&setTimeout(()=>{this.updateView(this.props.node)}),a.isInBackground!=this.props.isInBackground&&this.backgroundModeChange(a.isInBackground)}componentWillUnmount(){e.unRegister(this.key,this._onNativeViewMessage)}backgroundModeChange(a){a?e.triggerOnEvent({webviewID:this.key,eventName:'onAppEnterBackground'}):e.triggerOnEvent({webviewID:this.key,eventName:'onAppEnterForeground'})}operateNativeView(a){if(a)switch(a.action){case'operate':this.operateView(a);}}insertView(a){const{left:c,top:f,width:g,height:j}=a.position,k=this.props.deviceScale,l=this.key=`${a.name}${a.id}`,o=this.webview=d.get('simulator',{width:g,height:j,dpr:this.props.dpr});this.lastWidth=g,this.lastHeight=j,o.needDebugger=1;const p=n.getSessionToken(m.UA_TOKEN);o.setUserAgentOverride(`wechatdevtools port/${global.messageCenterPort} gamenativeview/${l} token/${p}`),o.setAttribute('allowtransparency',!0),o.setAttribute('style',`position:absolute;left:${c}px;top:${f}px;height:${g/k}px;width:${g/k}px;pointer-events:initial;`);const q={videoPlayerId:a.id,data:JSON.stringify(a.data),name:a.name};o.src=`http://127.0.0.1:${global.proxyPort}/game/nativeview.html?${b.stringify(q)}`,o.attach(this.container),o.on('dialog',(a)=>{a.preventDefault();const b=a.messageType,c=a.messageText,d=a.dialog;'prompt'===b&&(c===h.GET_MESSAGE_TOKEN?a.dialog.ok(i.getToken()):a.dialog.ok(''))}),e.register(l,this._onNativeViewMessage),this.webview=o}removeView(){this.webview&&(this.webview.detach(),this.webview=void 0),e.unRegister(this.key,this._onNativeViewMessage)}updateView(a){if(a.position&&this.webview){const{left:b,top:c,width:d,height:e}=a.position,f=this.props.deviceScale;this.webview.setAttribute('style',`position:absolute;left:${b}px;top:${c}px;height:${e/f}px;width:${d/f}px;pointer-events:initial;`),(this.lastHeight!=e||this.lastWidth!=d)&&(this.lastWidth=d,this.lastHeight=e,this.webview.setOffset({width:d,height:e,dpr:this.props.dpr}))}e.triggerOnEvent({webviewID:this.key,eventName:'updateNativeView',data:a.data})}operateView(a){a&&'operate'==a.action&&e.triggerOnEvent({webviewID:this.key,eventName:'operateNativeView',data:a.data})}onNativeViewMessage(a){let b={};try{if(b=JSON.parse(a),'WEBVIEW_PUBLISH'==b.command){const a=b.data.eventName;'videoPlayerInsert'==a?this.props.assdkCallback({callbackID:this.props.node.callbackID,res:{errMsg:`${this.props.node.api}:ok`}}):'onNativeViewEvent'==a&&f.triggerOnEvent({eventName:b.data.data.eventName,data:b.data.data.data})}}catch(b){g.error(`onNativeViewMessage catch ${a} error ${b}`)}}render(){const b=this.props;return a.createElement('div',{ref:(a)=>this.container=a,style:{}})}}module.exports=l((a)=>{const b=a.toolbar.deviceInfo,c=a.simulator.orientation&&/^landscape(Left|Right)?$/.test(a.simulator.orientation.value),d=a.simulator.operateNativeView,e=c?b.screenWidth:b.screenHeight;return{width:c?b.screenHeight:b.screenWidth,height:e,deviceScale:a.toolbar.deviceScale,dpr:b.dpr,compileCommand:a.simulator.compileCommand,project:a.project.current,isInBackground:a.simulator.backgroundShow,operateNativeView:d}},(a)=>({assdkCallback:j.bindActionCreators(k.assdkCallback,a)}))(o)}(require('lazyload'),require);