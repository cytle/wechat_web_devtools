'use strict';!function(require,directRequire){function a(){const a=h.getCurrent(),b=a.appid===l.TOURIST_APPID,c=a.setting.urlCheck;let d=!0;return b?d=!1:!c&&(d=!1),d}var b=Math.floor;const c=require('fs'),d=require('path'),e=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),f=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),g=require('./233d77ecf0781f44985f684f70e316d0.js'),h=require('./3bfffbe88b3d923921f851c0697974fe.js'),i=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),j=require('./dfd9a72b9ff6078018aa4a64eed949a5.js'),k=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),l=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),m=require('./8bf10a96e005fd88d01d949c3d2f8d46.js'),n=require('./common/locales/index.js'),o=l.CONTENTTYPEINFO,p=/^(http|ws)s?:\/\/[\w-.]+(:\d+)?/i;let q=0,r=0,s={},t=1,u={},v=1;module.exports={downloadFile:async function(b,f,e){const j=f.args;if(i.isLocalId(j.url)){const a=i.getFileRealPath(j.url);return a&&c.existsSync(a.fileRealPath)?{errMsg:`${f.api}:ok`,statusCode:200,tempFilePath:j.url}:{errMsg:`${f.api}:ok`,statusCode:404}}const m=e(),q=m.toolbar.network.list[m.toolbar.network.current];if('none'==q)return{errMsg:`${f.api}:fail network is down`};const s=h.getCurrent(),t=h.getCurrentRuntimeConfig();let u=h.isGameApp(s)?1024*(1024*t.setting.GameDownloadFileSizeLimit):1024*(1024*t.setting.DownloadFileSizeLimit);const v=m.simulator.appConfig||{},w=t.setting.MaxDownloadConcurrent;return r>=w?{errMsg:`${f.api}:fail exceed max download connection count ${w}`}:new Promise((b)=>{let e=!1;const q=(a)=>{e||(r--,b(a),e=!0)};try{r++;let b=0,e=200,t=d.extname(j.url.split('?')[0]);const w=i.createTmpfileName(s,t),x=i.getFileRealPath(w),y=x.fileRealPath,z=j.header&&'object'==typeof j.header?j.header:{};z.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;const A=m.toolbar&&m.toolbar.deviceInfo&&m.toolbar.deviceInfo.ua||'';z['User-Agent']=A.replace('{{webviewID}}','');let B=!1;const C={method:'get',url:j.url,encoding:null,headers:z,timeout:j.timeout||v.networkTimeout&&v.networkTimeout.downloadFile||6e4,followRedirect(b){if(!a())return!0;const c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){const a=b.caseless.get('location'),c=h.getCurrentRuntimeDomains().download;let d=p.exec(a.toLowerCase());d=d&&d[0]||'';for(let a=0;a<c.length;a++){const b=c[a];let e=p.exec(b.toLowerCase());if(e=e&&e[0],e==d)return!0}const e=[];c.forEach((a)=>{e.push([a])}),k.display({command:l.DISPLAY_INFO,type:l.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${a}`,domains:e}}),B=!0}return!1}};a()?C.agentOptions={secureProtocol:'TLSv1_2_method'}:C.tunnel=!1;const D=g(C),E=[];D.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)B?q({errMsg:`${f.api}:fail url not in domain list`}):q({errMsg:`${f.api}:ok`,statusCode:e});else{const b=parseInt(a.headers['content-length']);if(a.headers['content-type']){const b=a.headers['content-type'].replace(/;.*/g,''),c=o[b.toLowerCase()];if(c)t=`.${c}`;else{const a=b.split('/');a&&a[1]&&!/\-|\+/ig.test(a[1])&&(t=`.${a[1]}`)}}b>u&&(D.abort(),q({errMsg:`${f.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?q({errMsg:`${f.api}:fail ${n.config.TLS_VERSION_REQUIRED}`}):a&&'ETIMEDOUT'===a.code?q({errMsg:`${f.api}:fail timeout`}):q({errMsg:`${f.api}:fail ${a}`})}).on('data',(a)=>{b+=a.length,E.push(a),b>u&&(D.abort(),q({errMsg:`${f.api}:fail exceed max file size`}))}).on('end',()=>{const a=Buffer.concat(E),b=i.initTmpfileName(s,a,t),d=i.getFileRealPath(b),g=d.fileRealPath;c.writeFileSync(g,a),c.unlinkSync(y),q({errMsg:`${f.api}:ok`,tempFilePath:b,statusCode:e})}).pipe(c.createWriteStream(y))}catch(a){q({errMsg:`${f.api}:fail ${a}`})}})},uploadFile:async function(b,d,e){const f=d.args,j=h.getCurrentRuntimeConfig(),k=j.setting.MaxUploadConcurrent,l=e(),m=l.toolbar.network.list[l.toolbar.network.current];if('none'==m)return{errMsg:`${d.api}:fail network is down`};if(q>=k)return{errMsg:`${d.api}:fail exceed max upload connection count ${k}`};const o=f.filePath,p=i.getFileRealPath(o),r=p.fileRealPath;if(!c.existsSync(r))return{errMsg:`${d.api}:fail file not found`};const s=l.simulator.appConfig||{};return new Promise((b)=>{let e=!1;const i=(a)=>{e||(q--,e=!0,b(a))};try{q++;const b={url:f.url,headers:f.header||{},formData:f.formData||{},method:'post',timeout:f.timeout||s.networkTimeout&&s.networkTimeout.uploadFile||6e4};a()?b.agentOptions={secureProtocol:'TLSv1_2_method'}:b.tunnel=!1,b.formData[f.name]=c.createReadStream(r),b.headers.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;const e=l.toolbar&&l.toolbar.deviceInfo&&l.toolbar.deviceInfo.ua||'';b.headers['User-Agent']=e.replace('{{webviewID}}','');g(b,(a,b,c)=>{let e={};e=a?b&&b.statusCode?{errMsg:`${d.api}:ok`,statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{errMsg:`${d.api}:fail ${n.config.TLS_VERSION_REQUIRED}`}:'ETIMEDOUT'===a.code?{errMsg:`${d.api}:fail timeout`}:{errMsg:`${d.api}:fail ${a}`}:{errMsg:`${d.api}:ok`,statusCode:b.statusCode,data:c},i(e)})}catch(a){i({errMsg:`${d.api}:fail ${a}`})}})},createUploadTask:async function(d,k,e){const l=e(),o=k.args,p=h.getCurrentRuntimeConfig(),r=j(),u=p.setting.MaxUploadConcurrent,v=l.toolbar.network.list[l.toolbar.network.current];if('none'==v)return{errMsg:`${k.api}:fail network is down`};if(q>=u)return{errMsg:`${k.api}:fail exceed max upload connection count ${u}`};const w=o.filePath;let x=i.getFileRealPath(w);const y=x.fileRealPath;if(!c.existsSync(y))return{errMsg:`${k.api}:fail file not found`};const z=l.simulator.appConfig||{};let A=o.url;try{A=new URL(o.url).href}catch(a){}try{q++;const e={url:A,headers:o.header||{},formData:o.formData||{},method:'post',timeout:o.timeout||z.networkTimeout&&z.networkTimeout.uploadFile||6e4,time:!0};e.headers.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;const i=l.toolbar&&l.toolbar.deviceInfo&&l.toolbar.deviceInfo.ua||'';e.headers['User-Agent']=i.replace('{{webviewID}}',''),a()&&(e.agentOptions={secureProtocol:'TLSv1_2_method'});const j=c.createReadStream(y);e.formData[o.name]=j;const p=t++,u=c.statSync(y);let v=0;const w=Date.now(),B=`1.${p}`;d({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.requestWillBeSent',params:{requestId:B,documentURL:e.headers.Referer,request:{url:e.url,method:e.method,headers:e.headers},timestamp:w/1e3,type:'XHR'}}});Date.now()-w;j.on('data',function(a){v+=a.length,r.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:p,state:'progressUpdate',progress:b(100*(v/u.size)),totalBytesSent:v,totalBytesExpectedToSend:u.size}})});const C=(a)=>{s[p]&&(r.triggerOnEvent({eventName:'onUploadTaskStateChange',data:Object.assign({uploadTaskId:p},a)}),q--,delete s[p])},D=g(e);let E=0;const F=[];let G=200;return D.on('response',(a)=>{G=a.statusCode;const b={};for(let c=0,d=a.rawHeaders.length;c<d;c+=2)b[a.rawHeaders[c]]=a.rawHeaders[c+1]||'';const c=a.request.timings;d({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.responseReceived',params:{requestId:B,timestamp:Date.now()/1e3,type:'XHR',response:{url:e.url,status:a.statusCode,statusText:a.statusMessage,headers:b,connectionId:B,timing:{requestTime:w/1e3,proxyStart:0,proxyEnd:c.socket,dnsStart:c.socket,dnsEnd:c.lookup,connectStart:c.lookup,connectEnd:c.connect,sslStart:-1,sslEnd:-1,workerStart:-1,workerReady:-1,sendStart:c.connect,sendEnd:c.connect,pushStart:0,pushEnd:0,receiveHeadersEnd:c.response},protocol:a.request.uri.protocol.replace(/:$/,'')+'/'+a.httpVersion}}}}),r.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{downloadTaskId:p,state:'headersReceived',header:b}})}).on('error',(a)=>{x='EPROTO'===a.code?{state:'fail',errMsg:n.config.TLS_VERSION_REQUIRED}:'ETIMEDOUT'===a.code?{statSync:'fail',errMsg:'timeout'}:{state:'fail',errMsg:`${a}`},C(x),d({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:B,timestamp:Date.now()/1e3,type:'XHR',errorText:a.toString(),canceled:!1}}})}).on('data',(a)=>{E+=a.length,F.push(a),d({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.dataReceived',params:{requestId:B,timestamp:Date.now()/1e3,dataLength:a.length,encodedDataLength:a.length}}})}).on('abort',()=>{setTimeout(()=>{C({state:'fail',errMsg:'abort'})},0),d({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:B,timestamp:Date.now()/1e3,type:'XHR',errorText:'abort',canceled:!0}}})}).on('end',()=>{const a=Buffer.concat(F);C({state:'success',statusCode:G,data:a.toString()}),d({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFinished',params:{requestId:B,timestamp:Date.now()/1e3,dataLength:a.length,encodedDataLength:a.length}}}),m.set(B,a,'raw')}),s[p]={id:p,request:D},{errMsg:`${k.api}:ok`,uploadTaskId:p}}catch(a){return q--,{errMsg:`${k.api}:fail ${a}'`}}},operateUploadTask:async function(a,b){const c=b.args,d=c.uploadTaskId,e=c.operationType,f=s[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},createDownloadTask:async function(e,q,s){const t=q.args,w=s(),x=w.toolbar.network.list[w.toolbar.network.current],y=j(),z=h.getCurrent();if('none'==x)return{errMsg:`${q.api}:fail network is down`};if(t.url&&!/^https?:\/\//.test(t.url.toLowerCase()))return{errMsg:`${q.api}:fail invalid url`};const A=h.getCurrentRuntimeConfig(),B=A.setting.MaxDownloadConcurrent;if(r>=B)return{errMsg:`${q.api}:fail exceed max download connection count ${B}`};let C=h.isGameApp()?1024*(1024*A.setting.GameDownloadFileSizeLimit):1024*(1024*A.setting.DownloadFileSizeLimit);const D=t.header&&'object'==typeof t.header?t.header:{};D.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;const E=w.toolbar&&w.toolbar.deviceInfo&&w.toolbar.deviceInfo.ua||'';D['User-Agent']=E.replace('{{webviewID}}','');try{r++;let j=0;const s=[];let x=200,A=d.extname(t.url.split('?')[0]);const B=i.createTmpfileName(z,A),E=i.getFileRealPath(B),F=E.fileRealPath,G=w.simulator.appConfig||{};let H=!1,I=t.url;try{I=new URL(t.url).href}catch(a){}const J={method:'get',url:I,encoding:null,headers:D,timeout:t.timeout||G.networkTimeout&&G.networkTimeout.downloadFile||6e4,time:!0,followRedirect(b){if(!a())return!0;const c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){const a=h.getCurrentRuntimeDomains().download,c=b.caseless.get('location');let d=p.exec(c.toLowerCase());d=d&&d[0]||'';for(let b=0;b<a.length;b++){const c=a[b];let e=p.exec(c.toLowerCase());if(e=e&&e[0],e==d)return!0}const e=[];a.forEach((a)=>{e.push([a])}),k.display({command:l.DISPLAY_INFO,type:l.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${c}`,domains:e}}),H=!0}return!1}};a()?J.agentOptions={secureProtocol:'TLSv1_2_method'}:J.tunnel=!1;const K=v++,L=`2.${K}`,M=Date.now();e({type:f.ASSDK_CALLBACK,res:{errMsg:`${q.api}:ok`,downloadTaskId:K},callbackID:q.callbackID}),e({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.requestWillBeSent',params:{requestId:L,documentURL:D.Referer,request:{url:J.url,method:J.method,headers:D},timestamp:M/1e3,type:'XHR'}}});const N=g(J);u[K]={downloadTaskId:K,request:N};let O=C;const P=(a)=>{u[K]&&(delete u[K],r--,y.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:Object.assign({downloadTaskId:K},a)}))},Q=(a,c)=>{y.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:K,state:'progressUpdate',totalBytesWritten:a,totalBytesExpectedToWrite:c,progress:b(100*(a/c))}})};if(i.isLocalId(t.url)){const a=i.getFileRealPath(t.url);if(!(a&&c.existsSync(a.fileRealPath)))P({state:'success',statusCode:404});else if(t.filePath){const a=i.copyFile(z,t.url,t.filePath);a.error?P({state:'fail',statusCode:403,errMsg:`permission denied, open "${t.filePath}"`}):P({state:'success',filePath:t.filePath,statusCode:200})}else P({state:'success',tempFilePath:t.url,statusCode:200});return}N.on('response',(a)=>{if(x=a.statusCode,200!=x&&206!=x&&404!=x)H?P({state:'fail',errMsg:'url not in domain list'}):P({state:'success',statusCode:x});else{const b=parseInt(a.headers['content-length']);if(b>C?(N.abort(),P({state:'fail',errMsg:'exceed max file size'})):O=b,a.headers['content-type']){const b=a.headers['content-type'].replace(/;.*/g,''),c=o[b.toLowerCase()];if(c)A=`.${c}`;else{const a=b.split('/');a&&a[1]&&!/\-|\+/ig.test(a[1])&&(A=`.${a[1]}`)}}}const b={};for(let c=0,d=a.rawHeaders.length;c<d;c+=2)b[a.rawHeaders[c]]=a.rawHeaders[c+1]||'';const c=a.request.timings;e({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.responseReceived',params:{requestId:L,timestamp:Date.now()/1e3,type:'XHR',response:{url:J.url,status:a.statusCode,statusText:a.statusMessage,headers:b,connectionId:L,timing:{requestTime:M/1e3,proxyStart:0,proxyEnd:c.socket,dnsStart:c.socket,dnsEnd:c.lookup,connectStart:c.lookup,connectEnd:c.connect,sslStart:-1,sslEnd:-1,workerStart:-1,workerReady:-1,sendStart:c.connect,sendEnd:c.connect,pushStart:0,pushEnd:0,receiveHeadersEnd:c.response},protocol:a.request.uri.protocol.replace(/:$/,'')+'/'+a.httpVersion}}}}),y.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:K,state:'headersReceived',header:b}})}).on('error',function(a){a&&'EPROTO'===a.code?P({state:fail,errMsg:n.config.TLS_VERSION_REQUIRED}):a&&'ETIMEDOUT'===a.code?P({state:'fail',errMsg:'timeout'}):P({state:'fail',errMsg:`${a}`}),e({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:L,timestamp:Date.now()/1e3,type:'XHR',errorText:a.toString(),canceled:!1}}})}).on('data',(a)=>{j+=a.length,s.push(a),j>C?(P({state:'fail',errMsg:'exceed max file size'}),N.abort()):Q(j,O),e({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.dataReceived',params:{requestId:L,timestamp:Date.now()/1e3,dataLength:a.length,encodedDataLength:a.length}}})}).on('abort',()=>{setTimeout(()=>{P({state:'fail',errMsg:'abort'})},0),e({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFailed',params:{requestId:L,timestamp:Date.now()/1e3,type:'XHR',errorText:'abort',canceled:!0}}})}).on('end',(a)=>{a&&s.push(a);const b=Buffer.concat(s),d=i.initTmpfileName(z,b,A),g=i.getFileRealPath(d),h=g.fileRealPath;if(c.writeFileSync(h,b),c.unlinkSync(F),t.filePath){const a=i.rename(z,d,t.filePath);a.error?(P({state:'fail',errMsg:`permission denied, open "${t.filePath}"`,statusCode:x}),c.unlinkSync(d),c.unlinkSync(F),c.unlinkSync(h)):P({state:'success',filePath:t.filePath,statusCode:x})}else P({state:'success',tempFilePath:d,statusCode:x});e({type:f.SIMULATOR_DEBUG_INFO,data:{method:'Network.loadingFinished',params:{requestId:L,timestamp:Date.now()/1e3,dataLength:b.length,encodedDataLength:b.length}}}),m.set(L,h,'file')}).pipe(c.createWriteStream(F))}catch(a){return{errMsg:`${q.api}:fail ${a}`}}},operateDownloadTask:async function(a,b){const c=b.args,d=c.downloadTaskId,e=c.operationType,f=u[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},resetNetworkStatus:function(){for(let a in s)try{s[a].request.abort()}catch(a){}for(let a in u)try{u[a].request.abort()}catch(a){}q=0,r=0,s={},u={}}}}(require('lazyload'),require);