"use strict";function init(){var e=require("../../lib/react.js"),t=require("../../cssStr/cssStr.js"),a=require("../../stores/projectStores.js"),s=require("../../actions/webviewActions.js"),i=require("../../stores/backgroundAudioStores.js"),o=require("../../stores/windowStores.js"),r=require("../../utils/tools.js"),n=1,u=2,c=3,d=4,m=5,l=" ",p={},h=e.createClass({displayName:"Music",getInitialState:function(){return{showPlayer:!1,musicState:n,title:l}},_setAudioState:function(e,t){var a=e.args,s=a.src,i=a.title,o=(a.epname,a.singer),r=a.coverImgUrl;a.webUrl,a.startTime;p=a,this.audio||this._initMusic();var n=this.audio,u=n.src;u!==s&&s&&(n.src=s,this._play());var c=void 0;o&&i?c=o+" - "+i:o?c=o:i&&(c=i),this.setState({showPlayer:!0,title:c,coverImgUrl:r}),t({errMsg:"setBackgroundAudioState:ok"})},_getAudioState:function(e,t){var a=this.audio,s={duration:a?a.duration:0,currentTime:a?a.currentTime:0,paused:!a||a.paused,src:a?a.src:"",buffered:r.getAudioBufferd(a),title:a?p.title:"",epname:a?p.epname:"",singer:a?p.singer:"",coverImgUrl:a?p.coverImgUrl:"",webUrl:a?p.webUrl:"",startTime:a?p.startTime:"",errMsg:"getBackgroundAudioState:ok"};t(s)},_operateAudio:function(e,t){var a=e.args,s=a.operationType,i=a.currentTime;"play"===s?this._play():"pause"===s?this._pause():"stop"===s?this._stop():"seek"===s&&this._seek(i),t({errMsg:"operateBackgroundAudio:ok"})},_initMusic:function(){var e=this,t=document.createElement("audio");document.body.appendChild(t),this.audio=t,t.addEventListener("play",function(){e.setState({musicState:u}),s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"play"}})}),t.addEventListener("pause",function(){e.audio&&!e.audio.ended&&(e.audio.error||(e.setState({musicState:c}),s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"pause"}})))}),t.addEventListener("ended",function(){e.setState({musicState:d}),s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"ended"}})}),t.addEventListener("error",function(t){var a=t.target,i=a.error,o=i.code;o=o===i.MEDIA_ERR_NETWORK?10002:o===i.MEDIA_ERR_DECODE?10003:10001;var r=i.code;s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"error",errMsg:r,errCode:o}}),e.setState({musicState:m})}),t.addEventListener("canplay",function(e){s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"canplay"}})}),t.addEventListener("waiting",function(e){s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"waiting"}})})},_play:function(){this.audio&&this.audio.play()},_resume:function(e){var t=this.audio;t.paused&&t.play()},_pause:function(e){var t=this.audio;t&&!t.paused&&t.pause()},_seek:function(e){var t=this.audio;if(t&&!t.paused)try{t.currentTime=parseInt(e)}catch(e){}},_stop:function(){var e=this;this.audio&&setTimeout(function(){s.postMessageToAS({eventName:"onBackgroundAudioStateChange",data:{state:"stop"}}),e.audio.remove(),e.audio=void 0}),this.setState({musicState:d})},componentDidMount:function(){a.on("RESTART_PROJECT",this._stop),a.on("CLOSE_PROJECT",this._stop),o.on("BODY_CLICK",this._bodyClick),i.on("SET_BACKGROUND_AUDIO_STATE",this._setAudioState),i.on("GET_BACKGROUND_AUDIO_STATE",this._getAudioState),i.on("OPERATE_BACKGROUND_AUDIO",this._operateAudio)},componentWillUnmount:function(){a.removeListener("RESTART_PROJECT",this._stop),a.removeListener("CLOSE_PROJECT",this._stop),o.removeListener("BODY_CLICK",this._bodyClick),i.removeListener("SET_BACKGROUND_AUDIO_STATE",this._setAudioState),i.removeListener("GET_BACKGROUND_AUDIO_STATE",this._getAudioState),i.removeListener("OPERATE_BACKGROUND_AUDIO",this._operateAudio),this.audio&&this.audio.remove()},_bodyClick:function(e){this.setState({showPlayer:!1})},_showOrHide:function(e){this.setState({showPlayer:!this.state.showPlayer}),e.stopPropagation(),e.preventDefault()},_playOrPause:function(e){this.state.musicState==c?this._resume():this._pause(),e.stopPropagation(),e.preventDefault()},render:function(){var a=this.state.musicState==u||this.state.musicState==c?{}:t.displayNone,s=this.state.showPlayer?{}:t.displayNone,i=this.state.musicState==c?{}:t.displayNone,o=this.state.musicState==u?{}:t.displayNone,r=this.state.coverImgUrl?{}:t.displayNone;return e.createElement("div",{style:a,title:"音乐控件",onClick:this._showOrHide,className:"sidebar-item"},e.createElement("i",{className:"sidebar-item-icon  sidebar-item-icon-music"}),e.createElement("label",{className:"sidebar-item-label"},"音乐"),e.createElement("div",{className:"music-card",style:s,onClick:this._playOrPause},e.createElement("div",{className:"music-card-main"},e.createElement("p",{className:"music-card-status"},"正在播放"),e.createElement("p",{className:"music-card-name"},this.state.title)),e.createElement("div",{className:"music-card-image",style:r},e.createElement("img",{className:"music-card-image_img",src:this.state.coverImgUrl})),e.createElement("div",{className:"music-card-opr"},e.createElement("i",{className:"music-card-play-icon",style:i}),e.createElement("i",{className:"music-card-pause-icon",style:o}))))}});_exports=h}var _exports;init(),module.exports=_exports;