"use strict";function init(){var e=require("../../lib/react.js"),t=require("../../stores/webviewStores.js"),s=require("../../actions/leftviewActions.js"),i=require("../../stores/windowStores.js"),r=require("../../actions/windowActions.js"),o=require("../../actions/projectActions.js"),n=require("../../common/log/log.js"),a=require("../../config/config.js"),p=(require("../../common/jssdk/sdkNameTrans.js"),require("./console/consoleHandler.js")),c=require("./private/private.js"),u=!1,w=function(e){r.showTipsMsg({msg:e,type:"error"})},h=function(e,t){r.showConfirm({content:e,type:"confirm",callback:t})},v={},l=e.createClass({displayName:"WebviewBody",getInitialState:function(){return{webviewID:parseInt(this.props.webviewID)}},captureVisibleRegion:function(){var e=this;this.webview.captureVisibleRegion(function(t){e.props.getSimulatorActions("S_GET_SNAPSHOT",e.state.webviewID,{dataURI:t})})},reload:function(){this.webview.reload()},_setWebviewActions:function(e,t){var s=this,i=this.webview,r=t.act,n=this.postMessage;switch(this.props.project&&"reLoad"===r&&(r="reBuild"),r){case"reBuild":this.props.project&&setTimeout(function(){o.restart(s.props.project)},17);break;case"reLoad":this.reload();break;case"goBack":this.props.goBack();break;case"goForward":i.forward();break;case"load":u="urlbar"!==t.from,i.src=t.url;break;case"goToBlank":i.src="app/html/about.html";break;case"sendMsg":var a={sdkName:t.sdkName,res:t.res};n("webframe",a,"INVOKE_SDK",t.ext);break;case"sendMsgFromAppService":n("webframe",t,"MSG_FROM_APPSERVICE");break;case"open":nw.Shell.openExternal(i.src);break;case"CAPTURE":return void this.captureVisibleRegion()}},_getJSSDKRes:function(e,t,s,i){var r={sdkName:t,res:s};this.postMessage("webframe",r,"GET_JSSDK_RES",i)},setUserAgentOverride:function(e){e=e||i.getUA(),e=e.replace("{{webviewID}}",this.state.webviewID),this.props.project&&(e=e+" weapp/"+this.id),this.webview.setUserAgentOverride(e)},setWebviewSrc:function(e){this.webview.src=e},upWebviewStatus:function(e){var t=this.webview,s={url:t.src,canGoBack:t.canGoBack()};this.props.getSimulatorActions("S_UP_WEBVIEW_STATUS",this.state.webviewID,Object.assign(e,s))},loadstart:function(){var e=this;this.webview.addEventListener("loadstart",function(t){t.isTopLevel&&e.upWebviewStatus({loading:"start"})})},loadcommit:function(){var e=this,t=this.webview;t.addEventListener("loadcommit",function(s){if(s.isTopLevel&&(e.upWebviewStatus({type:"loadcommit"}),e.props.project&&(v={}),!e.initDevtools)){if(e.props.project){var i=e.props.offset;e.props.getSimulatorActions("S_START_DEBUGGEE",e.state.webviewID,{webview:t,webviewOffset:i})}else{var r=e.props.offset;e.props.getSimulatorActions("S_OPEN_DEVTOOLS",e.state.webviewID,{webview:t,webviewOffset:r})}e.initDevtools=!0}})},loadstop:function(){var e=this;this.webview.addEventListener("loadstop",function(t){e.upWebviewStatus({loading:"stop"}),e.props.project||e.postMessage("webframe",{},"COMMAND_GET_TITLE"),s.hideAll(e.state.webviewID)})},initEvent:function(){var e=this;this.loadstart(),this.loadcommit(),this.loadstop();var t=this.webview;global.appConfig.isDev||global.appConfig.isGamma||t.contextMenus.onShow.addListener(function(e){e.preventDefault()}),t.addEventListener("newwindow",function(e){"new_window"===e.windowOpenDisposition&&(t.src=e.targetUrl)}),t.addEventListener("dialog",function(t){var s=t.messageType||"",i=t.messageText,r=t.dialog;if("alert"===s)if(e.props.isMap&&0===i.indexOf("map handle:")){var o=i.replace("map handle:","");e.props.chooseLocation(JSON.parse(o))}else w(i);else if("confirm"===s)t.preventDefault(),h(i,function(e){e?r.ok():r.cancel()});else if("prompt"===s){var n=prompt(i);null!==n?r.ok(n):r.cancel()}})},onBeforeSendHeaders:function(){var e=this,t=this.webview,s=t.request;s.onBeforeSendHeaders.addListener(function(t){var s=e.props.project;if(s){var i=t.requestHeaders||[],r=i.findIndex(function(e){return"cookie"===e.name.toLowerCase()});i.splice(r,1);for(var o=0;o<i.length;++o)if("Referer"===i[o].name){var n=s.appid;s.platform&&s.ext_appid&&(n=s.ext_appid),i[o].value="https://servicewechat.com/"+n+"/devtools/page-frame.html"}return{requestHeaders:t.requestHeaders}}},{urls:["<all_urls>"]},["blocking","requestHeaders"])},onCompleted:function(){var e=this.webview,t=e.request;t.onCompleted.addListener(function(e){var t=e.type,s=e.statusCode;if("script"!==t&&"main_frame"!==t&&s>=400){e.url;p({message:a.WEBVIEW_NETWORK_ERROR,details:e})}},{urls:["<all_urls>"]},["responseHeaders"])},onErrorOccurred:function(){var e=this.webview,t=e.request;t.onErrorOccurred.addListener(function(e){var t=e.type;"script"!==t&&"main_frame"!==t&&"net::ERR_ABORTED"!==e.error&&p({message:a.WEBVIEW_NETWORK_ERROR,details:e})},{urls:["<all_urls>"]})},onBeforeRequest:function(){var e=this,t=this.webview,s=t.request;s.onBeforeRequest.addListener(function(t){var s=t.url,i=t.type;if("main_frame"!==i)return{};if(!u)return u=!0,{};if(/^chrome-extension:\/\//.test(s)||/^file:\/\//.test(s))return{};if(a.weappURLRegular.test(s))return{};var r=/\#wechat_redirect$/.test(s);return e.props.getSimulatorActions("S_GET_A8KEY",e.state.webviewID,{url:s,isSync:r}),{cancel:r}},{urls:["<all_urls>"]},["blocking"])},onHeadersReceived:function(){var e=this,t=this.webview,s=t.request;s.onHeadersReceived.addListener(function(t){var s=t.responseHeaders||[],i=(t.type,e.state.webviewID);return"main_frame"===t.type&&e.props.getSimulatorActions("S_CLEAN_WEBVIEW",i),{responseHeaders:s}},{urls:["<all_urls>"]},["blocking","responseHeaders"])},initRequest:function(){this.onBeforeRequest(),this.onBeforeSendHeaders(),this.onHeadersReceived(),this.onCompleted(),this.onErrorOccurred()},permissionrequest:function(){this.webview.addEventListener("permissionrequest",function(e){"geolocation"===e.permission&&e.request.allow()})},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/contentScript.js"]},run_at:"document_start"}])},_initport:function(e){var s=this;e.name==="webview"+this.state.webviewID&&(this.port=e,this.portID=e.name,t.addWebviewPorts(this.portID,this.port),this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.delWebviewPorts(s.portID),s.port.onMessage.removeListener(s.onMessage),delete s.port,delete s.portID,s.msgQuery=[]}),this.postMessage("contentscript",{},"SHAKE_HANDS"))},initRuntime:function(){chrome.runtime.onConnect.addListener(this._initport)},toAppService:function(e){e.webviewID=this.state.webviewID,this.props.getSimulatorActions("S_POSTMSG_TO_AS",this.state.webviewID,e)},onMessage:function(e){var t=this,s=e.command,r=this.state.webviewID,o=e.msg;if(this.props.project){var a=e.weappID;if(a!==this.id){n.error("webviewbody.js get a message from a wrong webview"),chrome.runtime.onConnect.removeListener(this._initport),n.info("webviewbody.js this.componentWillUnmount begin");try{this.componentWillUnmount(),n.info("webviewbody.js this.componentWillUnmount end")}catch(e){this.webview.remove(),n.error("webviewbody.js trigger this.componentWillUnmount() error "+e.toString())}return}}switch(s){case"COMMAND_GET_TITLE":this.upWebviewStatus(o);break;case"EXEC_JSSDK":var p=o.sdkName;if(/^private_/.test(p)){var u=p.replace(/^private_/,"");c[u]&&c[u](o.args,function(e,s){s=e?{errMsg:p+":fail"}:s,t._getJSSDKRes(r,p,s,{args:o.args})})}else o.ext=e.ext,this.props.getSimulatorActions("S_EXEC_JSSDK",r,o);break;case"TO_APP_SERVICE":this.toAppService(o);break;case"PULLDOWN_REFRESH":this.props.getSimulatorActions("S_POSTMSG_TO_AS",this.state.webviewID,{eventName:"onPullDownRefresh",data:{},webviewID:this.state.webviewID});break;case"WEBVIEW_READY":this.props.project&&("redirectTo"===this.props.type||"navigateTo"===this.props.type||"switchTab"===this.props.type||"reLaunch"===this.props.type?(this.props.postAppRoute(this.webview.src,this.state.webviewID,this.props.type),this.props.postAppRoute(this.webview.src,this.state.webviewID,this.props.type,!0)):0===this.state.webviewID&&(this.props.postAppRoute(this.webview.src,this.state.webviewID,"appLaunch"),this.props.postAppRoute(this.webview.src,this.state.webviewID,"appLaunch",!0)),i.isEditorFocus()||this.webview.focus())}},postMessage:function(e,t,s,i){var r=this,o={to:e,msg:t,command:s,ext:i};return o.webviewID=this.state.webviewID,o.id=this.id,this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){r.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(o)):void this.msgQuery.push(o)},_setInterfaceRes:function(e,t,s){"closeWindow"===t&&(0===e?this.webview.src="app/html/about.html":this.props.goBack(!0))},_setWebviewInfo:function(e){var t=this,s=e.ua;s&&this.setUserAgentOverride(s),this.props.project?setTimeout(function(){o.restart(t.props.project)},17):this.reload()},_clearWebviewData:function(e){var t=e.callBack;delete e.callBack,this.webview.clearData({since:0},e,function(){t&&t()})},_touchSetSuc:function(){this.setWebviewSrc(this.props.href)},_didMount:function(){var e=this.refs.container,s=this.state.webviewID,r=this.webview=document.createElement("webview");r.className="simulator-bd-webview_body webviewbody"+this.state.webviewID,r.setAttribute("partition","persist:simulator"),e.appendChild(r),this.setUserAgentOverride(),this.addContentScripts(),this.initRuntime();var o=this.props.href;this.props.project?(t.on("TOUCH_SET_SUC_"+s,this._touchSetSuc),r.src="about:blank",r.addEventListener("consolemessage",function(e){var t=e.message;v[t]||(v[t]=!0,p(e))})):this.setWebviewSrc(o),this.initEvent(),this.initRequest(),this.permissionrequest(),t.on("SET_WEBVIEW_ACTION_"+s,this._setWebviewActions),t.on("GET_JSSDK_RES_"+s,this._getJSSDKRes),t.on("SET_INTERFACE_RES_"+s,this._setInterfaceRes),i.on("INIT_DEVTOOLS_SUCCESS"+s,this._successDevtools),i.on("SET_WEBVIEW_INFO",this._setWebviewInfo),t.on("CLEAR_WEBVIEW_DATA",this._clearWebviewData),t.on("STOP_PULL_DOWN_REFRESH",this._onStopPullDownRefresh),t.on("TRIGGER_WEBVIEW_ON_EVENT",this._triggerWebviewOnEvent)},_triggerWebviewOnEvent:function(e){this.postMessage("webframe",e,"TRIGGER_WEBVIEW_ON_EVENT")},_onStopPullDownRefresh:function(){this.postMessage("webframe",{},"STOP_PULL_DOWN_REFRESH")},_successDevtools:function(){this.postMessage("webframe",{},"INIT_DEVTOOLS_SUCCESS")},componentDidMount:function(){this.id=parseInt(1e5*Math.random()),this.msgQuery=[],this.props.project&&0===this.state.webviewID?t.on("APPSERVICE_INIT",this._didMount):this._didMount()},componentWillUnmount:function(){var e=this.state.webviewID;this.initDevtools=!1,t.removeListener("CLEAR_WEBVIEW_DATA",this._clearWebviewData),t.removeListener("APPSERVICE_INIT",this._didMount),t.removeListener("SET_WEBVIEW_ACTION_"+e,this._setWebviewActions),t.removeListener("GET_JSSDK_RES_"+e,this._getJSSDKRes),t.removeListener("SET_INTERFACE_RES_"+e,this._setInterfaceRes),i.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),t.removeListener("STOP_PULL_DOWN_REFRESH",this._onStopPullDownRefresh),i.removeListener("INIT_DEVTOOLS_SUCCESS"+this.state.webviewID,this._successDevtools),t.removeListener("TRIGGER_WEBVIEW_ON_EVENT",this._triggerWebviewOnEvent),this.props.project&&t.removeListener("TOUCH_SET_SUC_"+e,this._touchSetSuc),chrome.runtime.onConnect.removeListener(this._initport),this.webview&&this.webview.remove()},render:function(){return e.createElement("div",{className:"simulator-bd-webview",ref:"container"})}});_exports=l}var _exports;init(),module.exports=_exports;