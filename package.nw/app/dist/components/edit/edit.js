'use strict';var _exports;function init(){function a(G){return G.replace(/\\/g,'/')}function b(G){return{mtime:+G.mtime,birthtime:+G.birthtime,isDir:G.isDirectory(),size:G.size}}function c(G){try{return f.lstatSync(G)}catch(H){return{isDirectory:()=>{return!1}}}}const d=require('glob'),f=require('fs'),g=require('path'),h=require('url'),j=require('rmdir'),k=require('../../lib/react.js'),l=require('../../cssStr/cssStr.js');require('../../actions/webviewActions.js');const m=require('../../actions/windowActions.js'),n=require('../../stores/windowStores.js');require('../../actions/projectActions.js');const o=require('../../weapp/utils/tools.js'),q=require('../../weapp/utils/projectManager.js'),r=require('../../stores/projectStores.js'),t=require('../../common/log/log.js'),{spawn:u,spawnSync:v,exec:w}=require('child_process'),x=require('./utils/editTools.js'),y=require('./utils/grep.js'),z=require('./utils/formatCode.js');var A={},B=!1;'win32'===process.platform;const C={'.jpg':!0,'.png':!0,'.jpeg':!0,'.icon':!0,'.gif':!0,'.svg':!0},D=function(G){m.showTipsMsg({msg:G,type:'error'})},E=function(G,H){m.showConfirm({content:G,callback:H})},F=k.createClass({displayName:'Edit',getInitialState:function(){return{project:this.props.project}},onMessage:function(G){let H=G.command,I=G.msg,J=G.ext,K=this.state.project;switch(H){case'GET_FILE_LIST':{if(B)return;B=!0;let L=I.options,M=L.ignore||['node_modules/**/*','node_modules'];d(`**`,{cwd:K.projectpath,ignore:M,nosort:!0,strict:!1,silent:!0},(N,O)=>{B=!1;let P={ret:N?N.toString():0,res:{files:N?[]:O,info:{}}};for(let Q=0;Q<O.length;Q++){let R=O[Q],S=g.join(K.projectpath,R),T=c(S),U=T.isDirectory();U&&(O[Q]=`${R}/`),P.res.info[O[Q]]=b(T)}O.forEach(Q=>{A[Q]=!0}),this.postMessage('webframe','RETURN_RES',P,J)});break}case'GET_FILE_DATA':{let L=I.path,M=g.extname(L);if(C[M]){let N='';try{N=decodeURI(h.resolve(o.getBaseURL(K),L))}catch(O){N=h.resolve(o.getBaseURL(K),L)}this.postMessage('webframe','RETURN_RES',{ret:0,res:{data:N}},J)}else{let N=g.join(K.projectpath,L);f.readFile(N,'utf8',(O,P)=>{let Q=c(N),R=b(Q),S={ret:O?O.toString():0,res:{data:O?'':P,info:R}};this.postMessage('webframe','RETURN_RES',S,J)})}break}case'SAVE_FILE_DATA':{let L=g.join(K.projectpath,I.path),M=I.data,N;try{f.writeFileSync(L,M,'utf8');let O=f.lstatSync(L),P=+O.mtime;if(A[a(I.path)]=P,N={ret:0,res:{path:I.path,info:b(O)}},'app.json'===I.path)try{let Q=JSON.parse(M),R=Q.pages||[];x.initPage(K,R)}catch(Q){}}catch(O){N={ret:O.toString(),res:''}}this.postMessage('webframe','RETURN_RES',N,J);break}case'DEL_FILE':{let L=I.path,M;try{f.unlinkSync(g.join(K.projectpath,L)),L=a(L),M={ret:0,res:L},delete A[L]}catch(N){M={ret:N.toString(),res:''}}this.postMessage('webframe','RETURN_RES',M,J);break}case'RENAME_FILE':{let L=g.join(K.projectpath,I.oldPath),M=g.join(K.projectpath,I.newPath),N,O=c(L);if(O.isDirectory()){q.manager.stopWatch();let P='darwin'===process.platform?'mv':'ren',Q='darwin'===process.platform?[`"${L}"`,`"${M}"`]:[`"${L}"`,`"${g.relative(g.dirname(M),M)}"`],R=[],S=[],T=u(P,Q,{shell:!0});T.on('close',U=>{q.manager.restartWatch(),N=0===U?{ret:0,res:{path:I.newPath,info:b(O)}}:{ret:'\u76EE\u5F55\u4FEE\u6539\u9519\u8BEF',res:''},this.postMessage('webframe','RETURN_RES',N,J)}),T.stdout.on('data',U=>{R.push(U)}),T.stderr.on('data',U=>{S.push(U)})}else{try{f.renameSync(L,M),delete A[a(I.oldPath)];let P=f.lstatSync(M);A[I.newPath]=!0,N={ret:0,res:{path:I.newPath,info:b(P)}}}catch(P){N={ret:P.toString(),res:''}}this.postMessage('webframe','RETURN_RES',N,J)}break}case'RM_DIR':{let L=K.projectpath,M=g.join(L,I.path);j(M,(N,O,P)=>{N||(O.forEach(R=>{let S=g.relative(L,R);S=a(S),delete A[S]}),P.forEach(R=>{let S=g.relative(L,R);S=a(S),delete A[S]}));let Q={ret:N?N.toString():0,res:N?'':O};this.postMessage('webframe','RETURN_RES',Q,J)});break}case'ADD_FILE':{let L=g.join(K.projectpath,I.path),M=f.existsSync(L),N;if(M)N={ret:`${I.path} already existed`},this.postMessage('webframe','RETURN_RES',N,J);else{try{f.writeFileSync(L,'','utf8'),A[a(I.path)]=!0;let O=f.lstatSync(L);N={ret:0,res:{path:I.path,info:b(O)}}}catch(O){N={ret:O.toString(),res:''}}this.postMessage('webframe','RETURN_RES',N,J)}break}case'MAKE_DIR':{let L=g.join(K.projectpath,I.path),M;try{f.mkdirSync(L),A[a(I.path)]=!0;let N=f.lstatSync(L);M={ret:0,res:{path:L,info:b(N)}}}catch(N){M={ret:N.toString(),res:''}}this.postMessage('webframe','RETURN_RES',M,J);break}case'GET_PROJECT_INFO':{this.postMessage('webframe','RETURN_RES',{ret:0,res:K},J);break}case'SET_EDIT_WEBVIEW':{let L=I.editWebview;r.setProjectEditWebview(K.hash,L),this.postMessage('webframe','RETURN_RES',{ret:0,res:L},J);break}case'FIND_STR':{let{options:L,str:M}=I,{cwd:N,i:O,wholeword:P}=L;N=g.join(K.projectpath,N),y({str:M,cwd:N,i:O,wholeword:P,project:K},(Q,R)=>{let S={};Q?S.ret=JSON.stringify(Q):(S.ret=0,S.res=R),this.postMessage('webframe','RETURN_RES',S,J)});break}case'SHOW_ITEM_IN_FOLDER':{let L=g.join(K.projectpath,I.filePath);nw.Shell.showItemInFolder(L);break}case'FORMAT_CODE':{let{code:L,options:M}=I;z(L,M,(N,O)=>{this.postMessage('webframe','RETURN_RES',{ret:0,res:O},J)});break}}},postMessage:function(G,H,I,J){let K={to:G,msg:I,command:H,ext:J};if(!this.port)return void this.msgQuery.push(K);this.msgQuery.length&&(this.msgQuery.forEach(L=>{this.port.postMessage(L)}),this.msgQuery=[]);this.port.postMessage(K)},initport:function(G){'edit'===G.name&&(this.port=G,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(()=>{this.port.onMessage.removeListener(this.onMessage),delete this.port,delete this.portID,this.msgQuery=[]}),this.postMessage('contentscript','SHAKE_HANDS',{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:'contentscript',matches:['<all_urls>'],js:{files:['app/dist/contentscript/editcontent.js']},run_at:'document_start'}])},ewWindow:function(){this.webview.addEventListener('newwindow',function(G){let H=G.targetUrl;H&&nw.Window.open(H,{width:799,height:799})})},_windowFocus:function(){'focus'===this.currentStatus||(this.postMessage('webframe','WINDOW_CHANGE',{eventType:'focus'},{}),setTimeout(()=>{this.webview.focus()},100),this.currentStatus='focus')},_windowBlur:function(){'blur'===this.currentStatus||(this.postMessage('webframe','WINDOW_CHANGE',{eventType:'blur'},{}),this.currentStatus='blur')},_editWebview:function(G,H){G.hash===this.props.project.hash&&this.postMessage('webframe','WEBVIEW_SHOW_CHANGE',{editWebview:H},{})},_openProjectFile:function(G){this.postMessage('webframe','OPEN_FILE',G,{})},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;let G=this.refs.container,H=this.webview=document.createElement('webview');H.className=`simulator-bd-webview_body`,H.setAttribute('partition','persist:trusted'),H.setUserAgentOverride(`${H.getUserAgent()} devtoolsedit`),G.appendChild(H),this.ewWindow(),this.addContentScripts(),this.initRuntime(),H.addEventListener('dialog',J=>{let K=J.messageType||'',L=J.messageText,M=J.dialog;if('alert'===K)D(L);else if('confirm'===K)J.preventDefault(),E(L,N=>{N?M.ok():M.cancel()});else if('prompt'===K){let N=prompt(L);null===N?M.cancel():M.ok(N)}});let I=q.manager;I.on('FILE_CHANGE',this._initWatcher),H.src='app/html/edit.html',n.on('WINDOW_BLUR',this._windowFocus),n.on('WINDOW_FOCUS',this._windowBlur),r.on('PROJECT_STORES_CHANGE_EDIT_WEBVIEW',this._editWebview),n.on('OPEN_PROJECT_FILE',this._openProjectFile)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),n.removeListener('WINDOW_BLUR',this._windowFocus),n.removeListener('WINDOW_FOCUS',this._windowBlur),r.removeListener('PROJECT_STORES_CHANGE_EDIT_WEBVIEW',this._editWebview),n.removeListener('OPEN_PROJECT_FILE',this._openProjectFile);let G=q.manager;G.removeListener('FILE_CHANGE',this._initWatcher),this.webview.remove(),A={}},_initWatcher:function(G,H,I,J){if(G.hash===this.state.project.hash){let O=J?+J.mtime:0,P=J?b(J):{},T={};I=a(I),g.join(G.projectpath,I);let U=A[I];if('unlinkDir'===H&&(U=A[`${I}/`]),('add'===H||'addDir'===H)&&!U)T={eventType:H,fileName:I,info:P};else if(('unlink'===H||'unlinkDir'===H)&&U)T={eventType:H,fileName:I,info:P},delete A[I];else if('change'===H){if(A[I]===O)return;A[I]=O,T={eventType:H,fileName:I,info:P}}else return void t.info(`edit.js watch ${H}`);this.postMessage('webframe','FILE_CHANGE',T,{})}},componentWillReceiveProps:function(G){'edit'===G.show?this._windowFocus():this._windowBlur()},render:function(){const{show:G,project:H}=this.props;let I='edit'===G?{}:l.displayNone;return k.createElement('div',{className:'edit',ref:'container',style:I})}});_exports=F}init(),module.exports=_exports;