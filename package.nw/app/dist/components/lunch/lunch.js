"use strict";function init(){var e=require("../../lib/react.js"),n=require("../../common/request/request.js"),t=(require("../../cssStr/cssStr.js"),require("../../actions/windowActions.js")),r=require("../../common/log/log.js"),i=require("../../config/urlConfig.js"),a="darwin"===process.platform?"darwin":"win",o="https://res.wx.qq.com/zh_CN/htmledition/v2/images/web_wechat_no_contect.png",s=function(e){t.showTipsMsg({msg:e,type:"error"})},c=e.createClass({displayName:"Lunch",handleOnClick:function(){this.props.appQuit()},componentDidMount:function(){var e=(this.refs.container,this.webview=document.createElement("webview"));e.src=i.LOGIN_URL,e.style.display="none",e.addEventListener("loadstop",this._loadstop),this.refs.container.innerHTML="",this.refs.container.appendChild(e)},componentWillUnmount:function(){this.webview&&this.webview.removeEventListener("loadstop",this._loadstop),this.refs.container.innerHTML=""},_hackStyle:function(){var e=this.webview;this.webview&&e.executeScript({code:"\n              var s = document.createElement('style')\n              s.innerText = `\n                body{\n                  overflow:hidden;\n                  background-color: #f0f0f0!important;\n                  padding: inherit!important;\n                  color: #373737!important;\n                }\n                .impowerBox .title {\n                  display: none;\n                }\n                .impowerBox .qrcode {\n                  width: 170px;\n                  height: 170px;\n                  margin-top: -7px;\n                }`\n                document.head.appendChild(s)\n                var normal = document.querySelectorAll('.normal')\n                for(var i = 0; i < normal.length; i++) {\n                  normal[i].classList.remove('normal')\n                }\n            "})},reload:function(){var e=this.webview;e&&e.reload()},_loadstop:function(e){var c=this,l=this.webview;this._hackStyle(),l.style.display="block";var d=l.request;d.onBeforeRequest.addListener(function(e){if("main_frame"!==e.type)return{};var l=e.url;return l==i.LOGIN_URL?(c.webview.style.display="none",{}):(l=l.replace("state=login","state="+a),r.info("lunch.js get URL : "+l),n({url:l},function(e,n,i){if(e)s("网络错误 "+e.toString()),c.reload();else{r.info("lunch.js get res "+JSON.stringify(i)),i=JSON.parse(i);var a=i.baseresponse,l=a.errcode?parseInt(a.errcode):0;if(0!==l)return s("登录失败，错误信息："+a.errmsg),void c.reload();for(var d in localStorage)0===d.indexOf("projectattr")&&delete localStorage[d];var p=n.headers,m=p["debugger-signature"],u=p["debugger-newticket"],h=+new Date,g={signature:m,newticket:u,openid:i.openid,nickName:i.nickname,headUrl:i.headurl||o,ticketExpiredTime:1e3*i.ticket_expired_time+h,signatureExpiredTime:1e3*i.signature_expired_time+h,sex:1===i.sex?"male":"female",province:i.province,city:i.city,contry:i.contry};t.upDateUserInfo(g)}}),{cancel:!0})},{urls:["<all_urls>"]},["blocking"]),r.info("lunch.js init loginWebview")},showSetting:function(){t.showSetting()},render:function(){var n="win32"===process.platform,t=n?"lunch-toolbar lunch-toolbar-win app-drag":"lunch-toolbar app-drag",r=e.createElement("a",{href:"javascript:;",onClick:this.showSetting,className:"create-toolbar-setting app-no-drag"},"代理",e.createElement("i",{className:"create-toolbar-setting-icon"})),i=n?"lunch-toolbar-close-icon app-no-drag":"app-no-drag";return e.createElement("div",{className:"lunch"},e.createElement("div",{className:t},n?r:"",e.createElement("a",{onClick:this.handleOnClick,href:"javascript:;",className:"lunch-toolbar-close app-no-drag"},e.createElement("i",{className:i})),n?"":r),e.createElement("div",{className:"lunch-body"},e.createElement("div",{className:"lunch-logo-wrapper"},e.createElement("i",{className:"lunch-logo"})),e.createElement("div",{className:"lunch-name"},"微信开发者工具"),e.createElement("div",{className:"lunch-line"}),e.createElement("div",{ref:"container",className:"lunch-qrcode"})))}});_exposts=c}var _exposts;init(),module.exports=_exposts;