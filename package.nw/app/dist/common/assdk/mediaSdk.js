"use strict";function init(){function e(e){var t=document.createElement("input");t.style.display="none",t.setAttribute("type","file"),e.accept&&t.setAttribute("accept",e.accept),e.multiple&&t.setAttribute("multiple","multiple"),global.contentDocumentBody.appendChild(t),t.addEventListener("change",function(a){e.sucCall&&e.sucCall(a),global.contentDocumentBody.removeChild(t)}),t.addEventListener("cancel",function(a){e.cancelCall&&e.cancelCall(a),global.contentDocumentBody.removeChild(t)}),t.click()}function t(e){var t=document.createElement("input");t.style.display="none",t.setAttribute("nwsaveas",e.name||""),t.setAttribute("type","file"),e.accept&&t.setAttribute("accept",e.accept),global.contentDocumentBody.appendChild(t),t.addEventListener("change",function(a){e.sucCall&&e.sucCall(a),global.contentDocumentBody.removeChild(t)}),t.addEventListener("cancel",function(a){e.cancelCall&&e.cancelCall(a),global.contentDocumentBody.removeChild(t)}),t.click()}function a(e){var t=v.lookup(e);return t.indexOf("video/")>=0}function i(e,t){d.sendASSDK("previewImage",e,t)}function n(t,i){var n=t.args,c=Number.isInteger(n.count)&&n.count<=9&&n.count>=1?n.count:9,o=n.mediaType||["video","image"],r=[],s=!1;o.indexOf("video")>=0&&r.push("video/*"),o.indexOf("image")>=0&&(s=!0,r.push("image/*")),e({accept:r.join(","),multiple:!!s&&c>1,sucCall:function(e){var n=u.getProjectByHash(t.apphash),o=e.target.value.split(";");o=o.slice(0,c);var r="";o.forEach(function(e){!r&&a(e)&&(r=e)});var s=[];if(r){var l=r,m=h.extname(l),d=g.statSync(l),v=p.copyFileToTemp(l,n.hash,m),f=document.createElement("video");f.setAttribute("src",v.replace("wxfile://","http://wxfile.open.weixin.qq.com/")),f.defaultMuted=!0,f.addEventListener("loadedmetadata",function(){f.play();var e=parseFloat(f.duration);e=isNaN(e)?0:e;var t=Math.min(100*e,500);setTimeout(function(){var e=document.createElement("canvas");e.width=f.videoWidth,e.height=f.videoHeight,e.getContext("2d").drawImage(f,0,0,e.width,e.height);var t=e.toDataURL().replace(/^data:image\/(jpg|png);base64,/,""),a=p.saveBase64DataToFile(n,t,".jpg");s.push({size:d.size,duration:f.duration,width:f.videoWidth,height:f.videoHeight,tempFilePath:v,thumbTempFilePath:a}),i({errMsg:"chooseMedia:ok",type:"video",tempFiles:s})},t)})}else o.forEach(function(e){var t=h.extname(e),a=g.statSync(e);s.push({tempFilePath:p.copyFileToTemp(e,n.hash,t),size:a.size})}),i({errMsg:"chooseMedia:ok",type:"image",tempFiles:s})},cancelCall:function(){i({errMsg:"chooseMedia:cancel"})}})}function c(t,a){var i=t.args,n=Number.isInteger(i.count)&&i.count<=9&&i.count>=1?i.count:9;e({accept:"image/*",multiple:n>1,sucCall:function(e){var i=u.getProjectByHash(t.apphash),c=e.target.value.split(";");c=c.slice(0,n);var o=[],r=[];c.forEach(function(e){var t=h.extname(e);try{var a=g.lstatSync(e);r.push(a.size)}catch(e){}o.push(p.copyFileToTemp(e,i.hash,t))}),a({errMsg:"chooseImage:ok",tempFilePaths:o,tempFileSizes:r})},cancelCall:function(){a({errMsg:"chooseImage:cancel"})}})}function o(t,a){t.args;e({accept:"video/*",sucCall:function(e){var i=u.getProjectByHash(t.apphash),n=e.target.value.split(";"),c=[],o=n[0],r=h.extname(o);c.push(p.copyFileToTemp(o,i.hash,r)),a({errMsg:"chooseVideo:ok",tempFilePath:c[0]})},cancelCall:function(){a({errMsg:"chooseVideo:cancel"})}})}function r(e,t){var a=e.args.src,i=p.isAppTmpPath(a),n=u.getProjectByHash(e.apphash),c=i?p.getRealPath(a):h.join(n.projectpath,a);if(!g.existsSync(c))return void t({errMsg:"getImageInfo:fail file not exist"});var o=g.createReadStream(c);m(o,function(e,a){t(e?{errMsg:"getImageInfo:fail "+e.toString()}:{errMsg:"getImageInfo:ok",width:a.width,height:a.height})})}function s(e,a){var i=e.sdkName,n=e.args,c=n.filePath,o=p.getRealPath(c);if(!g.existsSync(o))return a({errMsg:i+":fail file not exist"});var r=h.basename(o);t({name:r,accept:"video/*",sucCall:function(e){var t=e.target.value;try{g.writeFileSync(t,g.readFileSync(o)),a({errMsg:i+":ok"})}catch(e){a({errMsg:i+":fail "+e})}},cancelCall:function(){a({errMsg:i+":cancel"})}})}function l(e,a){var i=e.sdkName,n=e.args,c=n.filePath,o=p.getRealPath(c);if(!g.existsSync(o))return a({errMsg:i+":fail file not exist"});var r=h.basename(o);t({name:r,accept:"image/*",sucCall:function(e){var t=e.target.value;try{g.writeFileSync(t,g.readFileSync(o)),a({errMsg:i+":ok"})}catch(e){a({errMsg:i+":fail "+e})}},cancelCall:function(){a({errMsg:i+":cancel"})}})}var u=(require("../../utils/tools.js"),require("../../stores/projectStores.js")),p=require("../../utils/file.js"),h=require("path"),m=(require("url"),require("../../lib/imagesize.js")),g=require("fs"),d=(require("../../common/request/request.js"),require("../../weapp/utils/tools.js"),require("../../actions/webviewActions.js")),v=require("mime-types");_exports={chooseVideo:o,chooseImage:c,previewImage:i,getImageInfo:r,chooseMedia:n,saveVideoToPhotosAlbum:s,saveImageToPhotosAlbum:l}}var _exports;init(),module.exports=_exports;