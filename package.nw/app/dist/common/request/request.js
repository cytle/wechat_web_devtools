"use strict";function init(){function e(e){var r={};for(var t in e)"body"!==t&&(r[t]=e[t]);return JSON.stringify(r)}function r(e){var r=e.needToken,t=e.url;r!==-1&&(t=t.indexOf("?")===-1?t+"?newticket="+e.newticket:t+"&newticket="+e.newticket),0!==t.indexOf(d.CGI_DOMAIN)&&0!==t.indexOf(d.MP_DOMAIN)&&0!==t.indexOf(d.OPEN_DOMAIN)||(t=t.indexOf("?")===-1?t+"?os="+a+"&clientversion="+N:t+"&os="+a+"&clientversion="+N),e.url=t}function t(e,r,t){if(!e||!r)return t(f.NOT_LOGIN);var i={url:l,form:JSON.stringify({openid:e,signature:r}),method:"post",needToken:-1};n(i,function(e,r,i){if(e)u.error("request.js refreshTicket error "+JSON.stringify(e)),t(e);else{u.info("request.js refreshTicket "+i),i=JSON.parse(i);var n=i.baseresponse,o=parseInt(n.errcode);if(0!==o)return u.error("request.js refreshTicket errcode: "+o),void t(o);var s=+new Date+1e3*i.ticket_expired_time,c=r.headers,d=c["debugger-newticket"];require("../../actions/windowActions.js").upTicket(d,s),t(null,d)}})}function i(e,i){function n(r){var t=s.getProxyForURL(e.url);"DIRECT"!==t?(e.proxy="http://"+t.replace("PROXY ",""),e.tunnel=O):e.proxy=null,r(null)}function o(r){var i=e.needToken;if(i===-1)return void r(null);var n=1===i,o=require("../../stores/windowStores.js").getUserInfo();if((!o||!o.openid||!o.signature)&&n)return u.error("request.js setToken get userInfo null"),void r(f.NOT_LOGIN);var s=o.ticketExpiredTime,c=o.signatureExpiredTime,d=+new Date;return c<d&&n?(u.error("request.js setToken signature expired "+c+" "+d),void r(f.NOT_LOGIN)):void(s<d&&n?(u.error("request.js setToken ticket expired "+s+" "+d),t(o.openid,o.signature,function(t,i){t?(u.error("request.js refreshTicket error "+JSON.stringify(t)),r(f.NOT_LOGIN)):(e.newticket=i,r(null))})):(e.newticket=o?o.newticket:"",r(null)))}c.parallel([n,o],function(t){t?i(t,e):(r(e),delete e.newticket,delete e.needToken,i(null,e))})}function n(r,t){var s=JSON.parse(JSON.stringify(r)),c=r.needToken;r.loginForc!==-1;i(r,function(r,i){r?(require("../../stores/webviewStores.js").emit("NOT_LOGIN"),t(r),u.error("request.js makeRequestOpt _opt: "+e(i)+"  error: "+JSON.stringify(r)),require("../../actions/windowActions.js").clearUserInfo()):o(i,function(e,r,d){if(e)if(u.error("request.js request  "+i.url+" error "+JSON.stringify(e)),p[e.code]){if(O=!confirm("当前系统代理不是安全代理，是否信任？"),!O)return i.tunnel=!1,void o(i,function(e,r,i){t(e,r,i)})}else t(e);else{var a=r.statusCode;if(200!==a)return u.error("request.js request "+i.url+" statusCode "+a),void t("网络错误 statusCode : "+a,r,d);if(1===c){var l=void 0;try{l=JSON.parse(d)}catch(e){return void t(e.toString())}var N=l.baseresponse||{},v=parseInt(N.errcode);if(v===f.DEV_Need_ReLogin||v===f.NOT_LOGIN||v===f.DEV_Invalid_Signature||v===f.DEV_Expired_Signature)return u.info("request.js sendRequest get errcode "+v),t(v),void require("../../stores/webviewStores.js").emit("NOT_LOGIN");if(v===f.INVALID_TOKEN||v===f.INVALID_LOGIN)return require("../../stores/windowStores.js").delUserTicket(),void n(s,t)}t(e,r,d)}})})}var o=require("request"),s=require("../../utils/tools.js"),u=require("../log/log.js"),c=require("async"),d=require("../../config/urlConfig.js"),f=require("../../config/errcodeConfig.js"),a="darwin"===process.platform?"darwin":"win",l=d.refreshTicketURL,N=global.appVersion.replace(/\./g,""),O=!0,p={SELF_SIGNED_CERT_IN_CHAIN:!0,UNABLE_TO_VERIFY_LEAF_SIGNATURE:!0};_exports=n}var _exports;init(),module.exports=_exports;