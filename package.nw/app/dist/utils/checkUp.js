"use strict";function init(){function e(e){q.notifications({title:"有新版本",message:"新版本 "+e+" 已经准备好，立刻重启更新？",buttons:[{title:"重启"}]},function(e){if(0===e){try{m.unRegisterCommon(),m.unRegisterEdit()}catch(e){}chrome.runtime.reload()}})}function r(e){function r(){q.notifications({title:"有新版本",message:"新版本 "+e+" 已经准备好，立刻重启安装？",buttons:[{title:"安装新版本"}]},function(e){if(0===e){var r=S?"open":c,n=S?[c]:[];try{d(r,n,{detached:!0,cwd:k})}catch(e){var i=require("path");nw.Shell.openItem(i.join(k,c))}nw.App.quit()}})}var n=S?"darwin":"x64"===process.arch?"x64":"ia32",i=x+"&type="+n,t={url:i},o=v.getProxyForURL(i);"DIRECT"!==o&&(t.proxy="http://"+o.replace("PROXY ",""));var s=n+"_"+e+"."+(S?"ndmg":"nexe"),a=u.join(k,s),c=n+"_"+e+"."+(S?"dmg":"exe"),p=u.join(k,c);l.existsSync(p)?r():_(t,function(e,n,i){e||l.rename(a,p,function(e){e||r()})}).pipe(l.createWriteStream(a,{mode:511}))}function n(n,i){function t(e){var r={url:x+"&type="+i,needToken:0,encoding:null};c.info("checkUp.js begin fetch new version "+r.url),a(r,function(r,n,i){e(r,i)})}function s(e,r){g.gunzip(e,function(e,n){r(e,n)})}function d(e,r){l.writeFile(m,e,function(e){r(e,m)})}function v(e,r){var i=u.join(k,n.toString());f.sync(i);var t=S?u.join(i,"app.nw"):u.join(i,"package.nw");p.extractAll(e,t);var o=u.join(t,"package.json"),s=JSON.parse(l.readFileSync(o,"utf8"));S?(s.window.frame=!0,s["chromium-args"]="-ignore-certificate-errors -load-extension=/Applications/wechatwebdevtools.app/Contents/Resources/app.nw/app/dist/extensions/"):s["chromium-args"]="-ignore-certificate-errors -load-extension=./package.nw/app/dist/extensions/",l.writeFileSync(o,JSON.stringify(s),"utf8"),localStorage.setItem(N,n),r(null,n)}if(clearInterval(o),"app"===i||"big_code"===i)return void r(n);var m=u.join(k,""+i+n);if(l.existsSync(m))return c.info("checkUp.js "+m+" is existsSync"),localStorage.setItem(N,n),void e(n);var j=[];j.push(t),j.push(s),j.push(d),j.push(v),h.waterfall(j,function(r,n){return r?void c.error("checkUp.js async.waterfall "+r.toString()):void e(n)})}function i(e){var r=e.split("."),n=parseInt(r[0]),i=parseInt(r[1]),t=parseInt(r[2]);return n>O?"app":i>U?"big_code":t>A&&"small_code"}function t(e){var r=i(e.last_ide);r?(c.info("checkUp.js find new version "+e.last_ide+" and current version is "+R),n(e.last_ide,r)):(o&&clearInterval(o),o=setInterval(function(){var e={method:"post",url:w.LOADCONFIG_URL+"?type=checkup",needToken:0,body:JSON.stringify({type:7,version:nw.App.manifest.version})};a(e,function(e,r,n){if(e)c.info("checkUp.js onLineCheck error: "+e.toString());else{var i=JSON.parse(n),o=i.client_list,s={};o.forEach(function(e){s[e.key]=e.value}),t(s),y.checkConfig(s);var a=s.scene;if(a)try{a=JSON.parse(a),configStores.setSceneConfig(a)}catch(e){}}}),chrome.processes.getProcessInfo([],!0,function(e){var r=0;for(var n in e){var i=e[n];i.privateMemory&&(r+=i.privateMemory)}var t=j.getRestartInfo(),o=j.getCurrentProject();C("memory_monitor",o.appid,parseInt(r/1024/1024)+","+t.projectRestartNum)})},s))}var o,s=6e5,a=require("../common/request/request.js"),c=require("../common/log/log.js"),p=require("asar"),u=require("path"),l=require("fs"),f=require("mkdir-p"),g=require("zlib"),d=(require("rmdir"),require("child_process").spawn),v=require("./tools.js"),m=require("../common/shortCut/shortCut.js"),h=(g.createGunzip(),require("async")),j=require("../stores/projectStores.js"),w=require("../config/urlConfig.js"),y=require("../weapp/utils/vendorManager.js"),q=require("./notifyManager.js"),S="darwin"===process.platform,x=w.downloadRedirectURL+(S?"?os=darwin":"?os=win"),I=(global.appVersion,nw.App.getDataPath(),w.LOADCONFIG_URL,require("../config/dirConfig.js")),k=I.WeappApplication,_=(u.join(k,"uplog.json"),require("request")),C=require("./newReport.js"),R=global.appVersion,b=R.split("."),O=parseInt(b[0]),U=parseInt(b[1]),A=parseInt(b[2]),N="new-version";_exports=function(e){global.appConfig.isDev||(t(e),y.checkConfig(e))}}var _exports;init(),module.exports=_exports;