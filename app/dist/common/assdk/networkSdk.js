'use strict';var _exports;function init(){function a(l){let m=l.apphash,n=b.getProjectByHash(m),o=n.isTourist,p=n.urlCheck,q=!0;return o?q=!1:!p&&(q=!1),q}const b=require('../../stores/projectStores.js'),c=require('path'),d=require('../../utils/file'),e=require('fs'),f=require('request'),g=require('../../utils/tools.js'),h=require('../../config/appserviceConfig.js');let j=0,k=0;_exports={downloadFile:function(m,n){let o=m.args,p=b.getCurrentProject(),q=b.getCurrentProjectConfig(),r=1024*(1024*h.DownloadFileSizeLimit);if(k>=q.Setting.MaxDownloadConcurrent)return void n({errMsg:`downloadFile:fail exceed max download connection count ${q.Setting.MaxDownloadConcurrent}`});k++;let s=0,t=200,u=d.createNewLocalId(p)+c.extname(o.url.split('?')[0]),v=d.getRealPath(u);const w=A=>{'function'==typeof n&&(n(A),k--,n=void 0)};let x={method:'get',url:o.url,encoding:null,headers:o.header||{},followRedirect:function(A){let B=!1;(p.urlCheck||p.isTourist)&&(B=!0);let C=A.statusCode;if(300<=C&&400>C&&(302==C||301==C)){let D=A.caseless.get('location'),E=q.Network.DownloadDomain;for(let F=0;F<E.length;F++)if(D&&0===D.indexOf(E[F])){B=!0;break}}return B}};a(m)&&(x.agentOptions={secureProtocol:'TLSv1_2_method'});let y=g.getProxyForURL(x.url);'DIRECT'!==y&&(x.proxy='http://'+y.replace('PROXY ',''));let z=f(x);z.on('response',A=>{if(t=A.statusCode,200!=t&&206!=t)w({errMsg:`downloadFile:ok`,statusCode:t});else{let B=parseInt(A.headers['content-length']);B>r&&(z.abort(),w({errMsg:`downloadFile:fail exceed max file size`}))}}).on('error',function(A){A&&'EPROTO'===A.code?w({errMsg:'downloadFile:fail \u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}):w({errMsg:'downloadFile:fail '+A})}).on('data',A=>{s+=A.length,s>r&&(z.abort(),w({errMsg:`downloadFile:fail exceed max file size`}))}).on('end',A=>{w({errMsg:'downloadFile:ok',tempFilePath:u,statusCode:t})}).pipe(e.createWriteStream(v))},uploadFile:function(m,n){let o=m.args,p=b.getCurrentProjectConfig();return j>=p.Setting.MaxUploadConcurrent?void n({errMsg:`uploadFile:fail exceed max upload connection count ${p.Setting.MaxUploadConcurrent}`}):void(j++,o.tlsVersionCheck=a(m),o.callback=(q,r,s)=>{q?q&&'EPROTO'===q.code?n({errMsg:'uploadFile:fail \u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}):n({errMsg:'uploadFile:fail '+q}):n({errMsg:'uploadFile:ok',data:s,statusCode:r.statusCode}),j--},d.uploadFileToServer(o))}}}init(),module.exports=_exports;
