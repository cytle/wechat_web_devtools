'use strict';var _exports;function init(){const a=require('../../lib/react.js'),b=require('../../stores/webviewStores.js'),c=require('../../actions/leftviewActions.js'),d=require('../../stores/windowStores.js'),f=require('../../actions/windowActions.js'),g=require('../../actions/projectActions.js'),h=require('../../common/log/log.js'),j=require('../../config/config.js');require('../../common/jssdk/sdkNameTrans.js');const k=require('../../utils/newReport.js'),l=require('./console/consoleHandler.js'),m=require('./private/private.js');var n=!1;const o=function(s){f.showTipsMsg({msg:s,type:'error'})},p=function(s,t){f.showConfirm({content:s,type:'confirm',callback:t})};var q={};const r=a.createClass({displayName:'WebviewBody',getInitialState:function(){return{webviewID:parseInt(this.props.webviewID)}},captureVisibleRegion:function(){this.webview.captureVisibleRegion(s=>{this.props.getSimulatorActions('S_GET_SNAPSHOT',this.state.webviewID,{dataURI:s})})},reload:function(){this.webview.reload()},_setWebviewActions:function(s,t){let u=this.webview,v=t.act,w=this.postMessage;switch(this.props.project&&'reLoad'===v&&(v='reBuild'),v){case'reBuild':{this.props.project&&setTimeout(()=>{g.restart(this.props.project),k('project_shortcut_restart',this.props.project.appid)},17);break}case'reLoad':{this.reload();break}case'goBack':{this.props.goBack();break}case'goForward':{u.forward();break}case'load':{n='urlbar'!==t.from,u.src=t.url;break}case'goToBlank':{u.src='app/html/about.html';break}case'sendMsg':{let x={sdkName:t.sdkName,res:t.res};w('webframe',x,'INVOKE_SDK',t.ext);break}case'sendMsgFromAppService':{w('webframe',t,'MSG_FROM_APPSERVICE');break}case'open':{nw.Shell.openExternal(u.src);break}case'CAPTURE':this.captureVisibleRegion();}},_getJSSDKRes:function(s,t,u,v){this.postMessage('webframe',{sdkName:t,res:u},'GET_JSSDK_RES',v)},setUserAgentOverride:function(s){s=s||b.getUA(),s=s.replace('{{webviewID}}',this.state.webviewID),this.props.project&&(s=`${s} weapp/${this.id}`),this.webview.setUserAgentOverride(s)},setWebviewSrc:function(s){this.webview.src=s},upWebviewStatus:function(s){let t=this.webview,u={url:t.src,canGoBack:t.canGoBack()};this.props.getSimulatorActions('S_UP_WEBVIEW_STATUS',this.state.webviewID,Object.assign(s,u))},loadstart:function(){this.webview.addEventListener('loadstart',s=>{s.isTopLevel&&this.upWebviewStatus({loading:'start'})})},loadcommit:function(){let s=this.webview;s.addEventListener('loadcommit',t=>{if(t.isTopLevel&&(this.upWebviewStatus({type:'loadcommit'}),this.props.project&&(q={}),!this.initDevtools)){if(this.props.project){let u=this.props.offset;this.props.getSimulatorActions('S_START_DEBUGGEE',this.state.webviewID,{webview:s,webviewOffset:u})}else{let u=this.props.offset;this.props.getSimulatorActions('S_OPEN_DEVTOOLS',this.state.webviewID,{webview:s,webviewOffset:u})}this.initDevtools=!0}})},loadstop:function(){this.webview.addEventListener('loadstop',s=>{this.upWebviewStatus({loading:'stop'}),this.props.project||this.postMessage('webframe',{},'COMMAND_GET_TITLE'),c.hideAll(this.state.webviewID)})},initEvent:function(){this.loadstart(),this.loadcommit(),this.loadstop();let s=this.webview;global.appConfig.isDev||s.contextMenus.onShow.addListener(t=>{t.preventDefault()}),s.addEventListener('newwindow',t=>{'new_window'===t.windowOpenDisposition&&(s.src=t.targetUrl)}),s.addEventListener('dialog',t=>{let u=t.messageType||'',v=t.messageText,w=t.dialog;if('alert'===u){if(this.props.isMap&&0===v.indexOf('map handle:')){let x=v.replace('map handle:','');this.props.chooseLocation(JSON.parse(x))}else o(v);}else if('confirm'===u)t.preventDefault(),p(v,x=>{x?w.ok():w.cancel()});else if('prompt'===u){let x=prompt(v);null===x?w.cancel():w.ok(x)}})},onBeforeSendHeaders:function(){let s=this.webview,t=s.request;t.onBeforeSendHeaders.addListener(u=>{let v=this.props.project;if(v){let A=u.requestHeaders||[],B=A.findIndex(C=>{return'cookie'===C.name.toLowerCase()});A.splice(B,1);for(var y=0;y<A.length;++y)'Referer'===A[y].name&&(A[y].value=`https://servicewechat.com/${v.appid}/devtools/page-frame.html`);return{requestHeaders:u.requestHeaders}}},{urls:['<all_urls>']},['blocking','requestHeaders'])},onCompleted:function(){let s=this.webview,t=s.request;t.onCompleted.addListener(u=>{let{type:v,statusCode:w}=u;'script'!==v&&'main_frame'!==v&&400<=w&&l({message:j.WEBVIEW_NETWORK_ERROR,details:u})},{urls:['<all_urls>']},['responseHeaders'])},onErrorOccurred:function(){let s=this.webview,t=s.request;t.onErrorOccurred.addListener(u=>{let{type:v}=u;'script'===v||'main_frame'===v||'net::ERR_ABORTED'===u.error||l({message:j.WEBVIEW_NETWORK_ERROR,details:u})},{urls:['<all_urls>']})},onBeforeRequest:function(){let s=this.webview,t=s.request;t.onBeforeRequest.addListener(u=>{if('main_frame'!==u.type)return{};if(!n)return n=!0,{};let v=u.url;if(/^chrome-extension:\/\//.test(v)||/^file:\/\//.test(v))return{};if(j.weappURLRegular.test(v))return{};let w=/\#wechat_redirect$/.test(v);return this.props.getSimulatorActions('S_GET_A8KEY',this.state.webviewID,{url:v,isSync:w}),{cancel:w}},{urls:['<all_urls>']},['blocking'])},onHeadersReceived:function(){let s=this.webview,t=s.request;t.onHeadersReceived.addListener(u=>{let v=u.responseHeaders||[];u.type;let w=this.state.webviewID;if('main_frame'===u.type&&this.props.getSimulatorActions('S_CLEAN_WEBVIEW',w),'xmlhttprequest'===u.type){let x=!1;for(let y=0;y<v.length;y++){let z=v[y];'Access-Control-Allow-Origin'===z.name&&(z.value='*',x=!0)}return x||v.push({name:'Access-Control-Allow-Origin',value:'*'}),{responseHeaders:v}}},{urls:['<all_urls>']},['blocking','responseHeaders'])},initRequest:function(){this.onBeforeRequest(),this.onBeforeSendHeaders(),this.onHeadersReceived(),this.onCompleted(),this.onErrorOccurred()},permissionrequest:function(){this.webview.addEventListener('permissionrequest',function(s){'geolocation'===s.permission&&s.request.allow()})},addContentScripts:function(){this.webview.addContentScripts([{name:'contentscript',matches:['<all_urls>'],js:{files:['app/dist/contentscript/contentScript.js']},run_at:'document_start'}])},_initport:function(s){`webview${this.state.webviewID}`===s.name&&(this.port=s,this.portID=s.name,b.addWebviewPorts(this.portID,this.port),this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(()=>{b.delWebviewPorts(this.portID),this.port.onMessage.removeListener(this.onMessage),delete this.port,delete this.portID,this.msgQuery=[]}),this.postMessage('contentscript',{},'SHAKE_HANDS'))},initRuntime:function(){chrome.runtime.onConnect.addListener(this._initport)},toAppService:function(s){s.webviewID=this.state.webviewID,this.props.getSimulatorActions('S_POSTMSG_TO_AS',this.state.webviewID,s)},onMessage:function(s){let t=s.command,u=this.state.webviewID,v=s.msg;if(this.props.project){let w=s.weappID;if(w!==this.id){h.error(`webviewbody.js get a message from a wrong webview`),chrome.runtime.onConnect.removeListener(this._initport),h.info(`webviewbody.js this.componentWillUnmount begin`);try{this.componentWillUnmount(),h.info(`webviewbody.js this.componentWillUnmount end`)}catch(x){this.webview.remove(),h.error(`webviewbody.js trigger this.componentWillUnmount() error ${x.toString()}`)}return}}switch(t){case'COMMAND_GET_TITLE':{this.upWebviewStatus(v);break}case'EXEC_JSSDK':{let w=v.sdkName;if(/^private_/.test(w)){let x=w.replace(/^private_/,'');m[x]&&m[x](v.args,(y,z)=>{z=y?{errMsg:`${w}:fail`}:z,this._getJSSDKRes(u,w,z,{args:v.args})})}else v.ext=s.ext,this.props.getSimulatorActions('S_EXEC_JSSDK',u,v);break}case'TO_APP_SERVICE':{this.toAppService(v);break}case'PULLDOWN_REFRESH':{this.props.getSimulatorActions('S_POSTMSG_TO_AS',this.state.webviewID,{eventName:'onPullDownRefresh',data:{},webviewID:this.state.webviewID});break}case'WEBVIEW_READY':{this.props.project&&('redirectTo'===this.props.type||'navigateTo'===this.props.type||'switchTab'===this.props.type?this.props.postAppRoute(this.webview.src,this.state.webviewID,this.props.type):0===this.state.webviewID&&this.props.postAppRoute(this.webview.src,this.state.webviewID,'appLaunch'));break}}},postMessage:function(s,t,u,v){let w={to:s,msg:t,command:u,ext:v};return(w.webviewID=this.state.webviewID,w.id=this.id,!this.port)?void this.msgQuery.push(w):void(this.msgQuery.length&&(this.msgQuery.forEach(x=>{this.port.postMessage(x)}),this.msgQuery=[]),this.port.postMessage(w))},_setInterfaceRes:function(s,t,u){'closeWindow'===t&&(0===s?this.webview.src='app/html/about.html':this.props.goBack(!0))},_setWebviewInfo:function(s){let t=s.ua;t&&this.setUserAgentOverride(t),this.props.project?setTimeout(()=>{g.restart(this.props.project),k('project_shortcut_restart',this.props.project.appid)},17):this.reload()},_clearWebviewData:function(s){let t=s.callBack;delete s.callBack,this.webview.clearData({since:0},s,()=>{t&&t()})},_touchSetSuc:function(){this.setWebviewSrc(this.props.href)},_didMount:function(){let s=this.refs.container,t=this.state.webviewID,u=this.webview=document.createElement('webview');u.className=`simulator-bd-webview_body webviewbody${this.state.webviewID}`,u.setAttribute('partition','persist:trusted'),s.appendChild(u),this.setUserAgentOverride(),this.addContentScripts(),this.initRuntime();let v=this.props.href;this.props.project?(b.on(`TOUCH_SET_SUC_${t}`,this._touchSetSuc),u.src='about:blank',u.addEventListener('consolemessage',w=>{let x=w.message;q[x]||(q[x]=!0,l(w))})):this.setWebviewSrc(v),this.initEvent(),this.initRequest(),this.permissionrequest(),b.on(`SET_WEBVIEW_ACTION_${t}`,this._setWebviewActions),b.on(`GET_JSSDK_RES_${t}`,this._getJSSDKRes),b.on(`SET_INTERFACE_RES_${t}`,this._setInterfaceRes),d.on(`INIT_DEVTOOLS_SUCCESS${t}`,this._successDevtools),b.on('SET_WEBVIEW_INFO',this._setWebviewInfo),b.on('CLEAR_WEBVIEW_DATA',this._clearWebviewData),b.on('STOP_PULL_DOWN_REFRESH',this._onStopPullDownRefresh)},_onStopPullDownRefresh:function(){this.postMessage('webframe',{},'STOP_PULL_DOWN_REFRESH')},_successDevtools:function(){this.postMessage('webframe',{},'INIT_DEVTOOLS_SUCCESS')},componentDidMount:function(){this.id=parseInt(100000*Math.random()),this.msgQuery=[],this.props.project&&0===this.state.webviewID?b.on('APPSERVICE_INIT',this._didMount):this._didMount()},componentWillUnmount:function(){let s=this.state.webviewID;this.initDevtools=!1,b.removeListener('CLEAR_WEBVIEW_DATA',this._clearWebviewData),b.removeListener('APPSERVICE_INIT',this._didMount),b.removeListener(`SET_WEBVIEW_ACTION_${s}`,this._setWebviewActions),b.removeListener(`GET_JSSDK_RES_${s}`,this._getJSSDKRes),b.removeListener(`SET_INTERFACE_RES_${s}`,this._setInterfaceRes),b.removeListener('SET_WEBVIEW_INFO',this._setWebviewInfo),b.removeListener('STOP_PULL_DOWN_REFRESH',this._onStopPullDownRefresh),d.removeListener(`INIT_DEVTOOLS_SUCCESS${this.state.webviewID}`,this._successDevtools),this.props.project&&b.removeListener(`TOUCH_SET_SUC_${s}`,this._touchSetSuc),chrome.runtime.onConnect.removeListener(this._initport),this.webview&&this.webview.remove()},render:function(){return a.createElement('div',{className:'simulator-bd-webview',ref:'container'})}});_exports=r}init(),module.exports=_exports;